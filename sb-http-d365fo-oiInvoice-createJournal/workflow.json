{
    "definition": {
        "$schema": "https://schema.management.azure.com/providers/Microsoft.Logic/schemas/2016-06-01/workflowdefinition.json#",
        "actions": {
            "Check_PO": {
                "type": "If",
                "expression": {
                    "and": [
                        {
                            "contains": [
                                "@string(body('HTTP_request_for_OIinvoice_details'))",
                                "<CostCenterNumber>"
                            ]
                        }
                    ]
                },
                "actions": {
                    "Send_message_to_OI_comment": {
                        "type": "ServiceProvider",
                        "inputs": {
                            "parameters": {
                                "entityName": "open-invoice-post-update",
                                "message": {
                                    "contentData": {
                                        "OIinvoiceReceived": "0",
                                        "MessageBody": "D365 Journal creation skipped, since the invoice has a PO number",
                                        "OIDocumentID": "@{variables('ImageinvoiceId')}",
                                        "RetryQueue": "0"
                                    }
                                }
                            },
                            "serviceProviderConfiguration": {
                                "connectionName": "PrivateServiceBus",
                                "operationId": "sendMessage",
                                "serviceProviderId": "/serviceProviders/serviceBus"
                            }
                        },
                        "runAfter": {
                            "Send_message_audit_msg": [
                                "Succeeded"
                            ]
                        }
                    },
                    "Set_error_message": {
                        "type": "SetVariable",
                        "inputs": {
                            "name": "errorMessage",
                            "value": "Skipped"
                        },
                        "runAfter": {}
                    },
                    "Terminate_If_PO_Exists": {
                        "type": "Terminate",
                        "inputs": {
                            "runStatus": "Succeeded"
                        },
                        "runAfter": {
                            "Send_message_to_OI_comment": [
                                "SUCCEEDED"
                            ]
                        }
                    },
                    "Send_message_audit_msg": {
                        "type": "ServiceProvider",
                        "inputs": {
                            "parameters": {
                                "entityName": "open-invoice-audit",
                                "message": {
                                    "contentData": {
                                        "D365AttachmentAdded": "",
                                        "D365JENumber": "",
                                        "D365JournalCreated": "0",
                                        "D365JournalPosted": "0",
                                        "InRetryQueue": "",
                                        "LastUpdated": "@convertFromUtc(utcNow(), 'Mountain Standard Time')",
                                        "MessageBody": "D365 journal creaation skipped since invoice has PO number",
                                        "OIApproved": "1",
                                        "OIDocDataRetrieved": "",
                                        "OIDocumentID": "@body('Parse_JSON_imageinvoiceId')?['ImageInvoiceId']",
                                        "OIExported": "",
                                        "OIFutureDatedInvoice": "",
                                        "OIInvoiceAmount": "",
                                        "OIInvoiceNumber": "",
                                        "OIPOInvoice": "",
                                        "OIVendor": "",
                                        "OIInvoiceDate": "",
                                        "RetryCount": "0",
                                        "Identifier": "@{workflow()['run']['name']}",
                                        "WORKFLOW": "@{workflow()['name']}"
                                    }
                                }
                            },
                            "serviceProviderConfiguration": {
                                "connectionName": "PrivateServiceBus",
                                "operationId": "sendMessage",
                                "serviceProviderId": "/serviceProviders/serviceBus"
                            }
                        },
                        "runAfter": {
                            "Set_error_message": [
                                "Succeeded"
                            ]
                        }
                    }
                },
                "runAfter": {
                    "HTTP_request_for_OIinvoice_details": [
                        "Succeeded"
                    ]
                },
                "else": {
                    "actions": {
                        "Set_PO": {
                            "type": "SetVariable",
                            "inputs": {
                                "name": "PO",
                                "value": "false"
                            },
                            "runAfter": {}
                        }
                    }
                }
            },
            "Convert_base64_content_from_primary_SB": {
                "type": "Compose",
                "inputs": "@base64ToString(triggerOutputs()?['body']?['contentData']?['$content'])",
                "runAfter": {
                    "Initialize_variable_referenceData": [
                        "Succeeded"
                    ]
                }
            },
            "Compose_For_VendAccount": {
                "type": "Compose",
                "inputs": "@array(body('Parse_JSON_invoice_details')?['SupplierConnectInvoice']?['Invoice']?['InvoiceHeader']?['Partner'])",
                "runAfter": {
                    "Condition_for_invoiceDate": [
                        "Succeeded"
                    ]
                }
            },
            "Compose_ImageInvoice_to_Invoice": {
                "type": "Compose",
                "inputs": "@replace(outputs('Compose_XML'),'ImageInvoice','Invoice')",
                "runAfter": {
                    "Compose_XML": [
                        "Succeeded"
                    ]
                }
            },
            "Compose_XML": {
                "type": "Compose",
                "inputs": "@string(body('HTTP_request_for_OIinvoice_details'))",
                "runAfter": {
                    "Check_PO": [
                        "Succeeded"
                    ]
                }
            },
            "Compose_xml_to_json": {
                "type": "Compose",
                "inputs": "@json(xml(outputs('Compose_ImageInvoice_to_Invoice')))",
                "runAfter": {
                    "Compose_ImageInvoice_to_Invoice": [
                        "Succeeded"
                    ]
                }
            },
            "Condition_is_journals_created": {
                "type": "If",
                "expression": {
                    "and": [
                        {
                            "equals": [
                                "@length(variables('errorMessage'))",
                                0
                            ]
                        },
                        {
                            "equals": [
                                "@variables('RetryCondition')",
                                "False"
                            ]
                        },
                        {
                            "not": {
                                "equals": [
                                    "@length(variables('journalNum'))",
                                    0
                                ]
                            }
                        }
                    ]
                },
                "actions": {
                    "Check_and_post_journal": {
                        "type": "Http",
                        "inputs": {
                            "method": "POST",
                            "uri": "@{concat('https://', parameters('D365FO'), '/data/HSVendInvoiceJournalHeaders/Microsoft.Dynamics.DataEntities.ledgerJournalPost')}",
                            "body": {
                                "_journalNum": "@variables('journalNum')",
                                "_dataAreaId": "@variables('CompanyId')"
                            },
                            "authentication": {
                                "type": "ActiveDirectoryOAuth",
                                "tenant": "@parameters('TenantId')",
                                "audience": "@concat('https://',parameters('D365FO'))",
                                "clientId": "@appSetting('D365_API_CLIENT_ID')",
                                "secret": "@appsetting('D365_API_CLIENT_SECRET')"
                            },
                            "retryPolicy": {
                                "type": "fixed",
                                "count": 4,
                                "interval": "PT5S"
                            }
                        },
                        "runAfter": {}
                    },
                    "Switch": {
                        "type": "Switch",
                        "expression": "@body('Check_and_post_journal')?['value']",
                        "cases": {
                            "Case_-_Created_and_Posted_journal": {
                                "case": "success",
                                "actions": {
                                    "Post_message_to_OI_on_Creation_of_journal": {
                                        "type": "ServiceProvider",
                                        "inputs": {
                                            "parameters": {
                                                "entityName": "open-invoice-post-update",
                                                "message": {
                                                    "contentData": {
                                                        "MessageBody": "D365 journal creation successful: @{variables('journalNum')}",
                                                        "OIDocumentID": "@body('Parse_JSON_imageinvoiceId')?['ImageInvoiceId']",
                                                        "OIInvoiceReceived": "0",
                                                        "RetryQueue": "0"
                                                    }
                                                }
                                            },
                                            "serviceProviderConfiguration": {
                                                "connectionName": "PrivateServiceBus",
                                                "operationId": "sendMessage",
                                                "serviceProviderId": "/serviceProviders/serviceBus"
                                            }
                                        },
                                        "runAfter": {}
                                    },
                                    "Post_message_to_OI_on_posting_of_journal": {
                                        "type": "ServiceProvider",
                                        "inputs": {
                                            "parameters": {
                                                "entityName": "open-invoice-post-update",
                                                "message": {
                                                    "contentData": {
                                                        "MessageBody": "D365 journal posting successful: @{variables('journalNum')}",
                                                        "OIDocumentID": "@body('Parse_JSON_imageinvoiceId')?['ImageInvoiceId']",
                                                        "OIInvoiceReceived": "0",
                                                        "RetryQueue": "0"
                                                    }
                                                }
                                            },
                                            "serviceProviderConfiguration": {
                                                "connectionName": "PrivateServiceBus",
                                                "operationId": "sendMessage",
                                                "serviceProviderId": "/serviceProviders/serviceBus"
                                            }
                                        },
                                        "runAfter": {
                                            "Post_message_to_OI_on_Creation_of_journal": [
                                                "Succeeded"
                                            ]
                                        }
                                    },
                                    "Send_message_posting_success_Audit": {
                                        "type": "ServiceProvider",
                                        "inputs": {
                                            "parameters": {
                                                "entityName": "open-invoice-audit",
                                                "message": {
                                                    "contentData": {
                                                        "D365AttachmentAdded": "",
                                                        "D365JENumber": "",
                                                        "D365JournalCreated": "1",
                                                        "D365JournalPosted": "1",
                                                        "InRetryQueue": "",
                                                        "LastUpdated": "@{convertFromUtc(utcNow(), 'Mountain Standard Time')}",
                                                        "MessageBody": "D365 journal creation and posting successful: @{variables('journalNum')} ",
                                                        "OIApproved": "1",
                                                        "OIDocDataRetrieved": "",
                                                        "OIDocumentID": "@{body('Parse_JSON_imageinvoiceId')?['ImageInvoiceId']}",
                                                        "OIExported": "",
                                                        "OIFutureDatedInvoice": "",
                                                        "OIInvoiceAmount": "@{body('Parse_JSON_invoice_details')?['SupplierConnectInvoice']?['Invoice']?['InvoiceHeader']?['Total']}",
                                                        "OIInvoiceNumber": "@{body('Parse_JSON_invoice_details')?['SupplierConnectInvoice']?['Invoice']?['InvoiceHeader']?['InvoiceNumber']}",
                                                        "OIPOInvoice": "",
                                                        "OIVendor": "@{variables('VendName')}",
                                                        "OIInvoiceDate": "@{body('Parse_JSON_invoice_details')?['SupplierConnectInvoice']?['Invoice']?['InvoiceHeader']?['InvoiceDate']}",
                                                        "RetryCount": "0",
                                                        "Identifier": "@{workflow()['run']['name']}",
                                                        "WORKFLOW": "@{workflow()['name']}"
                                                    }
                                                }
                                            },
                                            "serviceProviderConfiguration": {
                                                "connectionName": "PrivateServiceBus",
                                                "operationId": "sendMessage",
                                                "serviceProviderId": "/serviceProviders/serviceBus"
                                            }
                                        },
                                        "runAfter": {
                                            "Post_message_to_OI_on_posting_of_journal": [
                                                "Succeeded"
                                            ]
                                        }
                                    }
                                }
                            },
                            "Case_journal_created_and_autopost-No": {
                                "case": "No",
                                "actions": {
                                    "Journal_creation_Send_message_to_audit_(topic)": {
                                        "type": "ServiceProvider",
                                        "inputs": {
                                            "parameters": {
                                                "entityName": "open-invoice-audit",
                                                "message": {
                                                    "contentData": {
                                                        "D365AttachmentAdded": "",
                                                        "D365JENumber": "@{variables('journalNum')}",
                                                        "D365JournalCreated": "1",
                                                        "D365JournalPosted": "0",
                                                        "InRetryQueue": "",
                                                        "LastUpdated": "@convertFromUtc(utcNow(), 'Mountain Standard Time')",
                                                        "MessageBody": "D365 journal creation successful: @{variables('journalNum')} ",
                                                        "OIApproved": "1",
                                                        "OIDocDataRetrieved": "",
                                                        "OIDocumentID": "@body('Parse_JSON_imageinvoiceId')?['ImageInvoiceId']",
                                                        "OIExported": "",
                                                        "OIFutureDatedInvoice": "",
                                                        "OIInvoiceAmount": "@{body('Parse_JSON_invoice_details')?['SupplierConnectInvoice']?['Invoice']?['InvoiceHeader']?['Total']}",
                                                        "OIInvoiceNumber": "@body('Parse_JSON_invoice_details')?['SupplierConnectInvoice']?['Invoice']?['InvoiceHeader']?['InvoiceNumber']",
                                                        "OIPOInvoice": "",
                                                        "OIVendor": "@{variables('VendName')}",
                                                        "OIInvoiceDate": "@{body('Parse_JSON_invoice_details')?['SupplierConnectInvoice']?['Invoice']?['InvoiceHeader']?['InvoiceDate']}",
                                                        "RetryCount": "0",
                                                        "Identifier": "@{workflow()['run']['name']}",
                                                        "WORKFLOW": "@{workflow()['name']}"
                                                    }
                                                }
                                            },
                                            "serviceProviderConfiguration": {
                                                "connectionName": "PrivateServiceBus",
                                                "operationId": "sendMessage",
                                                "serviceProviderId": "/serviceProviders/serviceBus"
                                            }
                                        },
                                        "runAfter": {}
                                    },
                                    "Post_message_to_OI_on_jour_creation": {
                                        "type": "ServiceProvider",
                                        "inputs": {
                                            "parameters": {
                                                "entityName": "open-invoice-post-update",
                                                "message": {
                                                    "contentData": {
                                                        "MessageBody": "D365 journal creation successful: @{variables('journalNum')}",
                                                        "OIDocumentID": "@body('Parse_JSON_imageinvoiceId')?['ImageInvoiceId']",
                                                        "OIInvoiceReceived": "0",
                                                        "RetryQueue": "0"
                                                    }
                                                }
                                            },
                                            "serviceProviderConfiguration": {
                                                "connectionName": "PrivateServiceBus",
                                                "operationId": "sendMessage",
                                                "serviceProviderId": "/serviceProviders/serviceBus"
                                            }
                                        },
                                        "runAfter": {
                                            "Journal_creation_Send_message_to_audit_(topic)": [
                                                "Succeeded"
                                            ]
                                        }
                                    }
                                }
                            }
                        },
                        "default": {
                            "actions": {
                                "Error_-_Delete_journal_and_lines_": {
                                    "type": "Http",
                                    "inputs": {
                                        "method": "POST",
                                        "uri": "@{concat('https://', parameters('D365FO'), '/data/HSVendInvoiceJournalHeaders/Microsoft.Dynamics.DataEntities.deleteJournal')}",
                                        "body": {
                                            "_journalNum": "@variables('journalNum')",
                                            "_dataAreaId": "@variables('CompanyId')"
                                        },
                                        "authentication": {
                                            "type": "ActiveDirectoryOAuth",
                                            "tenant": "@parameters('TenantId')",
                                            "audience": "@concat('https://',parameters('D365FO'))",
                                            "clientId": "@appSetting('D365_API_CLIENT_ID')",
                                            "secret": "@appsetting('D365_API_CLIENT_SECRET')"
                                        },
                                        "retryPolicy": {
                                            "type": "fixed",
                                            "count": 4,
                                            "interval": "PT5S"
                                        }
                                    },
                                    "runAfter": {}
                                },
                                "Check_for_retry_condition": {
                                    "type": "If",
                                    "expression": {
                                        "or": [
                                            {
                                                "contains": [
                                                    "@body('Check_and_post_journal')?['value']",
                                                    "finished or defined as a header project"
                                                ]
                                            },
                                            {
                                                "contains": [
                                                    "@body('Check_and_post_journal')?['value']",
                                                    "Finished and does not allow recording"
                                                ]
                                            },
                                            {
                                                "contains": [
                                                    "@body('Check_and_post_journal')?['value']",
                                                    "has a hold for"
                                                ]
                                            }
                                        ]
                                    },
                                    "actions": {
                                        "Send_to_retry_queue": {
                                            "type": "ServiceProvider",
                                            "inputs": {
                                                "parameters": {
                                                    "entityName": "open-invoice-retry",
                                                    "message": {
                                                        "contentData": {
                                                            "ImageInvoiceId": "@{variables('ImageinvoiceId')}"
                                                        },
                                                        "contentType": "text/plain"
                                                    }
                                                },
                                                "serviceProviderConfiguration": {
                                                    "connectionName": "PrivateServiceBus",
                                                    "operationId": "sendMessage",
                                                    "serviceProviderId": "/serviceProviders/serviceBus"
                                                }
                                            },
                                            "runAfter": {}
                                        }
                                    },
                                    "runAfter": {
                                        "Condition": [
                                            "Succeeded"
                                        ]
                                    }
                                },
                                "Send_message_to_audit(topic)_on_creation_of_journal_failed": {
                                    "type": "ServiceProvider",
                                    "inputs": {
                                        "parameters": {
                                            "entityName": "open-invoice-audit",
                                            "message": {
                                                "contentData": {
                                                    "D365AttachmentAdded": "",
                                                    "D365JENumber": "",
                                                    "D365JournalCreated": "0",
                                                    "D365JournalPosted": "0",
                                                    "InRetryQueue": "",
                                                    "LastUpdated": "@convertFromUtc(utcNow(), 'Mountain Standard Time')",
                                                    "MessageBody": "D365 journal creation failed: @{body('Check_and_post_journal')?['value']}",
                                                    "OIApproved": "1",
                                                    "OIDocDataRetrieved": "",
                                                    "OIDocumentID": "@body('Parse_JSON_imageinvoiceId')?['ImageInvoiceId']",
                                                    "OIExported": "",
                                                    "OIFutureDatedInvoice": "",
                                                    "OIInvoiceAmount": "@{body('Parse_JSON_invoice_details')?['SupplierConnectInvoice']?['Invoice']?['InvoiceHeader']?['Total']}",
                                                    "OIInvoiceNumber": "@body('Parse_JSON_invoice_details')?['SupplierConnectInvoice']?['Invoice']?['InvoiceHeader']?['InvoiceNumber']",
                                                    "OIPOInvoice": "",
                                                    "OIVendor": "@{variables('VendName')}",
                                                    "OIInvoiceDate": "@{body('Parse_JSON_invoice_details')?['SupplierConnectInvoice']?['Invoice']?['InvoiceHeader']?['InvoiceDate']}",
                                                    "RetryCount": "0",
                                                    "Identifier": "@{workflow()['run']['name']}",
                                                    "WORKFLOW": "@{workflow()['name']}"
                                                }
                                            }
                                        },
                                        "serviceProviderConfiguration": {
                                            "connectionName": "PrivateServiceBus",
                                            "operationId": "sendMessage",
                                            "serviceProviderId": "/serviceProviders/serviceBus"
                                        }
                                    },
                                    "runAfter": {
                                        "Error_-_Delete_journal_and_lines_": [
                                            "Succeeded"
                                        ]
                                    }
                                },
                                "Condition": {
                                    "type": "If",
                                    "expression": {
                                        "and": [
                                            {
                                                "equals": [
                                                    "@triggerOutputs()?['body']?['to']",
                                                    "retry"
                                                ]
                                            }
                                        ]
                                    },
                                    "actions": {},
                                    "runAfter": {
                                        "Send_message_to_audit(topic)_on_creation_of_journal_failed": [
                                            "Succeeded"
                                        ]
                                    },
                                    "else": {
                                        "actions": {
                                            "Send_comment_to_OI": {
                                                "type": "ServiceProvider",
                                                "inputs": {
                                                    "parameters": {
                                                        "entityName": "open-invoice-post-update",
                                                        "message": {
                                                            "contentData": {
                                                                "OIinvoiceReceived": "0",
                                                                "MessageBody": "D365 journal creation failed: @{body('Check_and_post_journal')?['value']}.",
                                                                "OIDocumentID": "@{variables('ImageinvoiceId')}",
                                                                "RetryQueue": "0"
                                                            }
                                                        }
                                                    },
                                                    "serviceProviderConfiguration": {
                                                        "connectionName": "PrivateServiceBus",
                                                        "operationId": "sendMessage",
                                                        "serviceProviderId": "/serviceProviders/serviceBus"
                                                    }
                                                },
                                                "runAfter": {}
                                            }
                                        }
                                    }
                                },
                                "Terminate_3": {
                                    "type": "Terminate",
                                    "inputs": {
                                        "runStatus": "Failed"
                                    },
                                    "runAfter": {
                                        "Check_for_retry_condition": [
                                            "Succeeded"
                                        ]
                                    }
                                }
                            }
                        },
                        "runAfter": {
                            "Check_and_post_journal": [
                                "Succeeded"
                            ]
                        }
                    }
                },
                "runAfter": {
                    "For_each_Attachment": [
                        "Succeeded",
                        "TIMEDOUT",
                        "SKIPPED",
                        "FAILED"
                    ]
                },
                "else": {
                    "actions": {
                        "Condition_Check_for_Skip_error_message_or_retry_queue": {
                            "type": "If",
                            "expression": {
                                "or": [
                                    {
                                        "equals": [
                                            "@variables('errorMessage')",
                                            "Skipped"
                                        ]
                                    },
                                    {
                                        "not": {
                                            "equals": [
                                                "@length(variables('errorLog'))",
                                                0
                                            ]
                                        }
                                    }
                                ]
                            },
                            "actions": {
                                "Check_whether_the_record_should_go_to_retry_queue": {
                                    "type": "If",
                                    "expression": {
                                        "or": [
                                            {
                                                "contains": [
                                                    "@variables('errorLog')",
                                                    "finished or defined as a header project"
                                                ]
                                            },
                                            {
                                                "contains": [
                                                    "@variables('errorLog')",
                                                    "Finished and does not allow recording"
                                                ]
                                            },
                                            {
                                                "contains": [
                                                    "@variables('errorLog')",
                                                    "D365 vendor number lookup failed"
                                                ]
                                            },
                                            {
                                                "equals": [
                                                    "",
                                                    ""
                                                ]
                                            },
                                            {
                                                "and": [
                                                    {
                                                        "contains": [
                                                            "@variables('errorLog')",
                                                            "@variables('errorMessage')"
                                                        ]
                                                    }
                                                ]
                                            }
                                        ]
                                    },
                                    "actions": {
                                        "Send_message": {
                                            "type": "ServiceProvider",
                                            "inputs": {
                                                "parameters": {
                                                    "entityName": "open-invoice-retry",
                                                    "message": {
                                                        "contentData": {
                                                            "ImageInvoiceId": "@{variables('ImageinvoiceId')}"
                                                        },
                                                        "contentType": "text/plain"
                                                    }
                                                },
                                                "serviceProviderConfiguration": {
                                                    "connectionName": "PrivateServiceBus",
                                                    "operationId": "sendMessage",
                                                    "serviceProviderId": "/serviceProviders/serviceBus"
                                                }
                                            },
                                            "runAfter": {}
                                        }
                                    },
                                    "runAfter": {}
                                },
                                "check_if_income_msg_from_retry_queue": {
                                    "type": "If",
                                    "expression": {
                                        "and": [
                                            {
                                                "equals": [
                                                    "@triggerOutputs()?['body']?['to']",
                                                    "retry"
                                                ]
                                            }
                                        ]
                                    },
                                    "actions": {},
                                    "runAfter": {
                                        "Send_Audit_For_Journal_Creation_Failed_": [
                                            "Succeeded"
                                        ]
                                    },
                                    "else": {
                                        "actions": {
                                            "Send_message_post_invoice_update_": {
                                                "type": "ServiceProvider",
                                                "inputs": {
                                                    "parameters": {
                                                        "entityName": "open-invoice-post-update",
                                                        "message": {
                                                            "contentData": {
                                                                "MessageBody": "D365 journal creation failed: @{variables('errorMessage')}",
                                                                "OIDocumentID": "@body('Parse_JSON_imageinvoiceId')?['ImageInvoiceId']",
                                                                "OIInvoiceReceived": "0",
                                                                "RetryQueue": "0"
                                                            }
                                                        }
                                                    },
                                                    "serviceProviderConfiguration": {
                                                        "connectionName": "PrivateServiceBus",
                                                        "operationId": "sendMessage",
                                                        "serviceProviderId": "/serviceProviders/serviceBus"
                                                    }
                                                },
                                                "runAfter": {}
                                            }
                                        }
                                    }
                                },
                                "Terminate_2": {
                                    "type": "Terminate",
                                    "inputs": {
                                        "runStatus": "Failed"
                                    },
                                    "runAfter": {
                                        "check_if_income_msg_from_retry_queue": [
                                            "Succeeded"
                                        ]
                                    }
                                },
                                "Send_Audit_For_Journal_Creation_Failed_": {
                                    "type": "ServiceProvider",
                                    "inputs": {
                                        "parameters": {
                                            "entityName": "open-invoice-audit",
                                            "message": {
                                                "contentData": {
                                                    "D365AttachmentAdded": "",
                                                    "D365JENumber": "",
                                                    "D365JournalCreated": "0",
                                                    "D365JournalPosted": "0",
                                                    "InRetryQueue": "",
                                                    "LastUpdated": "@{convertFromUtc(utcNow(), 'Mountain Standard Time')}",
                                                    "MessageBody": "D365 journal creation failed: @{variables('journalNum')}, Error Message:@{variables('errorMessage')} ",
                                                    "OIApproved": "1",
                                                    "OIDocDataRetrieved": "",
                                                    "OIDocumentID": "@{body('Parse_JSON_imageinvoiceId')?['ImageInvoiceId']}",
                                                    "OIExported": "",
                                                    "OIFutureDatedInvoice": "",
                                                    "OIInvoiceAmount": "@{body('Parse_JSON_invoice_details')?['SupplierConnectInvoice']?['Invoice']?['InvoiceHeader']?['Total']}",
                                                    "OIInvoiceNumber": "@{body('Parse_JSON_invoice_details')?['SupplierConnectInvoice']?['Invoice']?['InvoiceHeader']?['InvoiceNumber']}",
                                                    "OIPOInvoice": "",
                                                    "OIVendor": "@{variables('VendName')}",
                                                    "OIInvoiceDate": "@{body('Parse_JSON_invoice_details')?['SupplierConnectInvoice']?['Invoice']?['InvoiceHeader']?['InvoiceDate']}",
                                                    "RetryCount": "0",
                                                    "Identifier": "@{workflow()['run']['name']}",
                                                    "WORKFLOW": "@{workflow()['name']}"
                                                }
                                            }
                                        },
                                        "serviceProviderConfiguration": {
                                            "connectionName": "PrivateServiceBus",
                                            "operationId": "sendMessage",
                                            "serviceProviderId": "/serviceProviders/serviceBus"
                                        }
                                    },
                                    "runAfter": {
                                        "Check_whether_the_record_should_go_to_retry_queue": [
                                            "Succeeded"
                                        ]
                                    }
                                }
                            },
                            "runAfter": {},
                            "else": {
                                "actions": {
                                    "Delete_incorrect_journal_and_lines": {
                                        "type": "Http",
                                        "inputs": {
                                            "method": "POST",
                                            "uri": "@{concat('https://', parameters('D365FO'), '/data/HSVendInvoiceJournalHeaders/Microsoft.Dynamics.DataEntities.deleteJournal')}",
                                            "body": {
                                                "_journalNum": "@variables('journalNum')",
                                                "_dataAreaId": "@variables('CompanyId')"
                                            },
                                            "authentication": {
                                                "type": "ActiveDirectoryOAuth",
                                                "tenant": "@parameters('TenantId')",
                                                "audience": "@concat('https://',parameters('D365FO'))",
                                                "clientId": "@appSetting('D365_API_CLIENT_ID')",
                                                "secret": "@appsetting('D365_API_CLIENT_SECRET')"
                                            },
                                            "retryPolicy": {
                                                "type": "fixed",
                                                "count": 4,
                                                "interval": "PT5S"
                                            }
                                        },
                                        "runAfter": {}
                                    },
                                    "Post_message_to_OI": {
                                        "type": "ServiceProvider",
                                        "inputs": {
                                            "parameters": {
                                                "entityName": "open-invoice-post-update",
                                                "message": {
                                                    "contentData": {
                                                        "MessageBody": "D365 journal creation failed: @{variables('errorMessage')}",
                                                        "OIDocumentID": "@body('Parse_JSON_imageinvoiceId')?['ImageInvoiceId']",
                                                        "OIInvoiceReceived": "0",
                                                        "RetryQueue": "1"
                                                    }
                                                }
                                            },
                                            "serviceProviderConfiguration": {
                                                "connectionName": "PrivateServiceBus",
                                                "operationId": "sendMessage",
                                                "serviceProviderId": "/serviceProviders/serviceBus"
                                            }
                                        },
                                        "runAfter": {
                                            "Send_message_to_audit_topic": [
                                                "Succeeded"
                                            ]
                                        }
                                    },
                                    "Send_message_to_audit_topic": {
                                        "type": "ServiceProvider",
                                        "inputs": {
                                            "parameters": {
                                                "entityName": "open-invoice-audit",
                                                "message": {
                                                    "contentData": {
                                                        "D365AttachmentAdded": "",
                                                        "D365JENumber": "",
                                                        "D365JournalCreated": "0",
                                                        "D365JournalPosted": "0",
                                                        "InRetryQueue": "",
                                                        "LastUpdated": "@convertFromUtc(utcNow(), 'Mountain Standard Time')",
                                                        "MessageBody": "@concat('D365 journal creation failed: ', variables('errorMessage'))",
                                                        "OIApproved": "1",
                                                        "OIDocDataRetrieved": "",
                                                        "OIDocumentID": "@body('Parse_JSON_imageinvoiceId')?['ImageInvoiceId']",
                                                        "OIExported": "",
                                                        "OIFutureDatedInvoice": "",
                                                        "OIInvoiceAmount": "@{body('Parse_JSON_invoice_details')?['SupplierConnectInvoice']?['Invoice']?['InvoiceHeader']?['Total']}",
                                                        "OIInvoiceNumber": "@body('Parse_JSON_invoice_details')?['SupplierConnectInvoice']?['Invoice']?['InvoiceHeader']?['InvoiceNumber']",
                                                        "OIPOInvoice": "",
                                                        "OIVendor": "@{variables('VendName')}",
                                                        "OIInvoiceDate": "@{body('Parse_JSON_invoice_details')?['SupplierConnectInvoice']?['Invoice']?['InvoiceHeader']?['InvoiceDate']}",
                                                        "RetryCount": "1",
                                                        "Identifier": "@{workflow()['run']['name']}",
                                                        "WORKFLOW": "@{workflow()['name']}"
                                                    }
                                                }
                                            },
                                            "serviceProviderConfiguration": {
                                                "connectionName": "PrivateServiceBus",
                                                "operationId": "sendMessage",
                                                "serviceProviderId": "/serviceProviders/serviceBus"
                                            }
                                        },
                                        "runAfter": {
                                            "Delete_incorrect_journal_and_lines": [
                                                "Succeeded"
                                            ]
                                        }
                                    },
                                    "Check_to_send_msg_to_retry_queue_for_the_first_time": {
                                        "type": "If",
                                        "expression": {
                                            "or": [
                                                {
                                                    "contains": [
                                                        "@variables('errorMessage')",
                                                        "finished or defined as a header project"
                                                    ]
                                                },
                                                {
                                                    "contains": [
                                                        "@variables('errorMessage')",
                                                        "D365 vendor number lookup failed"
                                                    ]
                                                },
                                                {
                                                    "contains": [
                                                        "@variables('errorMessage')",
                                                        "Finished and does not allow recording"
                                                    ]
                                                }
                                            ]
                                        },
                                        "actions": {
                                            "Send_msg_to_Retry_queue": {
                                                "type": "ServiceProvider",
                                                "inputs": {
                                                    "parameters": {
                                                        "entityName": "open-invoice-retry",
                                                        "message": {
                                                            "contentData": {
                                                                "ImageInvoiceId": "@{variables('ImageinvoiceId')}"
                                                            },
                                                            "contentType": "text/plain"
                                                        }
                                                    },
                                                    "serviceProviderConfiguration": {
                                                        "connectionName": "PrivateServiceBus",
                                                        "operationId": "sendMessage",
                                                        "serviceProviderId": "/serviceProviders/serviceBus"
                                                    }
                                                },
                                                "runAfter": {}
                                            }
                                        },
                                        "runAfter": {
                                            "Post_message_to_OI": [
                                                "Succeeded"
                                            ]
                                        }
                                    },
                                    "Terminate": {
                                        "type": "Terminate",
                                        "inputs": {
                                            "runStatus": "Failed"
                                        },
                                        "runAfter": {
                                            "Check_to_send_msg_to_retry_queue_for_the_first_time": [
                                                "Succeeded"
                                            ]
                                        }
                                    }
                                }
                            }
                        }
                    }
                }
            },
            "For_each_Attachment": {
                "type": "Foreach",
                "foreach": "@body('Parse_JSON_invoice_details')?['SupplierConnectInvoice']?['AttachmentsReference']?['Attachment']",
                "actions": {
                    "Set_attachment": {
                        "type": "Http",
                        "inputs": {
                            "method": "POST",
                            "uri": "@{concat('https://', parameters('D365FO'), '/data/HSVendInvoiceJournalLines/Microsoft.Dynamics.DataEntities.addAttachment')}",
                            "body": {
                                "_FileContent": "@variables('content')",
                                "_journalNum": "@variables('journalNum')",
                                "_filename": "@{concat(body('Parse_JSON_invoice_details')?['SupplierConnectInvoice']?['Invoice']?['InvoiceHeader']?['InvoiceNumber'] ,' - ',variables('FileCount'),'.',last(variables('FileType')))}",
                                "_UploadDate": "@{utcNow()}",
                                "_dataareaid": "@variables('CompanyId')",
                                "_fileNameType": "pdf"
                            },
                            "authentication": {
                                "type": "ActiveDirectoryOAuth",
                                "tenant": "@parameters('TenantId')",
                                "audience": "@concat('https://',parameters('D365FO'))",
                                "clientId": "@appSetting('D365_API_CLIENT_ID')",
                                "secret": "@appsetting('D365_API_CLIENT_SECRET')"
                            },
                            "retryPolicy": {
                                "type": "fixed",
                                "count": 4,
                                "interval": "PT5S"
                            }
                        },
                        "runAfter": {
                            "Condition_to_Check_file_type_of_attachment": [
                                "Succeeded"
                            ]
                        }
                    },
                    "HTTP_request_for_attachment": {
                        "type": "Http",
                        "inputs": {
                            "method": "GET",
                            "uri": "@{parameters('OIUrl')}@{variables('LocationPath')}",
                            "authentication": {
                                "type": "ClientCertificate",
                                "pfx": "@appSetting('OPEN_INVOICE_API_CERT')",
                                "password": "@appSetting('OPEN_INVOICE_API_CERT_PASSWORD')"
                            }
                        },
                        "runAfter": {
                            "Set_LocationPath": [
                                "Succeeded"
                            ]
                        }
                    },
                    "Set_LocationPath": {
                        "type": "SetVariable",
                        "inputs": {
                            "name": "LocationPath",
                            "value": "@items('For_each_Attachment')?['LocationPath']"
                        },
                        "runAfter": {
                            "Set_FileType": [
                                "Succeeded"
                            ]
                        }
                    },
                    "Condition_to_Check_file_type_of_attachment": {
                        "type": "If",
                        "expression": {
                            "or": [
                                {
                                    "contains": [
                                        "@variables('FileType')",
                                        "csv"
                                    ]
                                },
                                {
                                    "contains": [
                                        "@variables('FileType')",
                                        "txt"
                                    ]
                                }
                            ]
                        },
                        "actions": {
                            "Set_CSV_or_TXT_attachment_Content": {
                                "type": "SetVariable",
                                "inputs": {
                                    "name": "content",
                                    "value": "@{base64(body('HTTP_request_for_attachment'))}"
                                },
                                "runAfter": {}
                            }
                        },
                        "runAfter": {
                            "HTTP_request_for_attachment": [
                                "SUCCEEDED"
                            ]
                        },
                        "else": {
                            "actions": {
                                "Set_attachment_content_for_non_csv_and_non_txt_file_type": {
                                    "type": "SetVariable",
                                    "inputs": {
                                        "name": "content",
                                        "value": "@{body('HTTP_request_for_attachment')?['$content']}"
                                    },
                                    "runAfter": {}
                                }
                            }
                        }
                    },
                    "Set_error_message_for_attachment_fail": {
                        "type": "SetVariable",
                        "inputs": {
                            "name": "errorMessage",
                            "value": "@body('Set_attachment')?['value']"
                        },
                        "runAfter": {
                            "Set_attachment": [
                                "TIMEDOUT",
                                "SKIPPED",
                                "FAILED"
                            ]
                        }
                    },
                    "Increment_FileCount": {
                        "type": "IncrementVariable",
                        "inputs": {
                            "name": "FileCount",
                            "value": 1
                        },
                        "runAfter": {}
                    },
                    "Set_FileType": {
                        "type": "SetVariable",
                        "inputs": {
                            "name": "FileType",
                            "value": "@split(variables('UniversalResourceIdentifier'),'.')"
                        },
                        "runAfter": {
                            "Set_UniversalResourceIdentifier": [
                                "Succeeded"
                            ]
                        }
                    },
                    "Set_UniversalResourceIdentifier": {
                        "type": "SetVariable",
                        "inputs": {
                            "name": "UniversalResourceIdentifier",
                            "value": "@items('For_each_Attachment')?['UniversalResourceIdentifier']"
                        },
                        "runAfter": {
                            "Increment_FileCount": [
                                "Succeeded"
                            ]
                        }
                    }
                },
                "runAfter": {
                    "For_each_on_Partner_to_find_Vendor": [
                        "Succeeded"
                    ]
                },
                "runtimeConfiguration": {
                    "concurrency": {
                        "repetitions": 1
                    }
                }
            },
            "For_each_on_Partner_to_find_Vendor": {
                "type": "Foreach",
                "foreach": "@body('Parse_JSON_for_VendAccount')",
                "actions": {
                    "Condition_to_check_valid_data_to_continue_process": {
                        "type": "If",
                        "expression": {
                            "and": [
                                {
                                    "equals": [
                                        "@items('For_each_on_Partner_to_find_Vendor')['@PartnerType']",
                                        "Supplier"
                                    ]
                                },
                                {
                                    "not": {
                                        "equals": [
                                            "@variables('VendCount')",
                                            1
                                        ]
                                    }
                                },
                                {
                                    "equals": [
                                        "@length(variables('errorMessage'))",
                                        0
                                    ]
                                },
                                {
                                    "equals": [
                                        "@variables('RetryCondition')",
                                        "False"
                                    ]
                                }
                            ]
                        },
                        "actions": {
                            "Condition_for_valid_FO_VendaccountNum": {
                                "type": "If",
                                "expression": {
                                    "and": [
                                        {
                                            "not": {
                                                "equals": [
                                                    "@body('Execute_action_to_find_FO_VendAccount')?['value']",
                                                    ""
                                                ]
                                            }
                                        }
                                    ]
                                },
                                "actions": {
                                    "Compose_Line_details": {
                                        "type": "Compose",
                                        "inputs": "@array(body('Parse_JSON_invoice_details')?['SupplierConnectInvoice']?['Invoice']?['InvoiceDetails']?['LineItem'])",
                                        "runAfter": {
                                            "Create_Vendor_journal_line": [
                                                "Succeeded"
                                            ]
                                        }
                                    },
                                    "Create_Header": {
                                        "type": "Http",
                                        "inputs": {
                                            "method": "POST",
                                            "uri": "@{concat('https://', parameters('D365FO'), '/data/HSVendInvoiceJournalHeaders')}",
                                            "body": {
                                                "JournalName": "@parameters('OIJournalName')",
                                                "dataAreaId": "@{if(equals(variables('CompanyID'),'Legal'),'SESC',variables('CompanyID'))}",
                                                "Description": "@{if(contains(string(body('HTTP_request_for_OIinvoice_details')),'AFENumber'),'PRJ','AP')}-@{formatDateTime(convertFromUtc(utcNow(),'Mountain Standard Time','MM/dd/yyyy'),'MM')}@{formatDateTime(convertFromUtc(utcNow(),'Mountain Standard Time','MM/dd/yyyy'),'dd')}@{formatDateTime(convertFromUtc(utcNow(),'Mountain Standard Time','MM/dd/yyyy'),'yy')}-@{body('Parse_JSON_invoice_details')?['SupplierConnectInvoice']?['Invoice']?['InvoiceHeader']?['InvoiceNumber']}-@{substring(body('Execute_action_vend_Name')?['value'],add(indexOf(body('Execute_action_vend_Name')?['value'],','),1))}"
                                            },
                                            "authentication": {
                                                "type": "ActiveDirectoryOAuth",
                                                "tenant": "@parameters('TenantId')",
                                                "audience": "@concat('https://',parameters('D365FO'))",
                                                "clientId": "@appSetting('D365_API_CLIENT_ID')",
                                                "secret": "@appsetting('D365_API_CLIENT_SECRET')"
                                            },
                                            "retryPolicy": {
                                                "type": "fixed",
                                                "count": 4,
                                                "interval": "PT5S"
                                            }
                                        },
                                        "runAfter": {
                                            "Set_vendName": [
                                                "Succeeded"
                                            ]
                                        }
                                    },
                                    "Create_Vendor_journal_line": {
                                        "type": "Http",
                                        "inputs": {
                                            "method": "POST",
                                            "uri": "@{concat('https://', parameters('D365FO'), '/data/HSVendInvoiceJournalLines')}",
                                            "body": {
                                                "JournalBatchNumber": "@body('Create_Header')?['JournalBatchNumber']",
                                                "Currency": "@body('Parse_JSON_invoice_details')?['SupplierConnectInvoice']?['Invoice']?['InvoiceHeader']?['CurrencyCode']",
                                                "dataAreaId": "@body('Create_Header')?['dataAreaId']",
                                                "LineNumber": "@variables('LineNum')",
                                                "Credit": "@if(greater(variables('Total'),0.00),variables('Total'),0.00)",
                                                "MainAccountNumber": "@body('Execute_action_to_find_FO_VendAccount')?['value']",
                                                "InvoiceDate": "@body('Parse_JSON_invoice_details')?['SupplierConnectInvoice']?['Invoice']?['InvoiceHeader']?['InvoiceDate']",
                                                "Debit": "@if(less(variables('Total'),0.00),mul(variables('Total'),-1),0.00)",
                                                "Description": "@body('Parse_JSON_invoice_details')?['SupplierConnectInvoice']?['Invoice']?['InvoiceHeader']?['LongDescription']",
                                                "AccountType": "Vend",
                                                "Invoice": "@body('Parse_JSON_invoice_details')?['SupplierConnectInvoice']?['Invoice']?['InvoiceHeader']?['InvoiceNumber']",
                                                "HSOIInvoiceId": "@body('Parse_JSON_invoice_details')?['SupplierConnectInvoice']?['Invoice']?['@id']"
                                            },
                                            "authentication": {
                                                "type": "ActiveDirectoryOAuth",
                                                "tenant": "@parameters('TenantId')",
                                                "audience": "@concat('https://',parameters('D365FO'))",
                                                "clientId": "@appSetting('D365_API_CLIENT_ID')",
                                                "secret": "@appsetting('D365_API_CLIENT_SECRET')"
                                            },
                                            "retryPolicy": {
                                                "type": "fixed",
                                                "count": 4,
                                                "interval": "PT5S"
                                            }
                                        },
                                        "runAfter": {
                                            "Set_journalNum": [
                                                "Succeeded"
                                            ]
                                        }
                                    },
                                    "For_each_Line_details": {
                                        "type": "Foreach",
                                        "foreach": "@outputs('Compose_Line_details')",
                                        "actions": {
                                            "Compose_to_get_the_coding_tag_records_from_the_line_details": {
                                                "type": "Compose",
                                                "inputs": "@array(body('Parse_JSON_line_item_details')?['Coding'])",
                                                "runAfter": {
                                                    "Parse_JSON_line_item_details": [
                                                        "Succeeded"
                                                    ]
                                                }
                                            },
                                            "Compose_line_item_details": {
                                                "type": "Compose",
                                                "inputs": "@items('For_each_Line_details')",
                                                "runAfter": {}
                                            },
                                            "For_each_line": {
                                                "type": "Foreach",
                                                "foreach": "@body('Filter_array')",
                                                "actions": {
                                                    "Condition_to_check_for_AFE_number": {
                                                        "type": "If",
                                                        "expression": {
                                                            "and": [
                                                                {
                                                                    "not": {
                                                                        "equals": [
                                                                            "@items('For_each_line')?['AFENumber']",
                                                                            "@null"
                                                                        ]
                                                                    }
                                                                }
                                                            ]
                                                        },
                                                        "actions": {
                                                            "Compose_for_referencedata_tag_in_XML": {
                                                                "type": "Compose",
                                                                "inputs": "@array(items('For_each_line')?['ReferenceData'])",
                                                                "runAfter": {}
                                                            },
                                                            "For_each": {
                                                                "type": "Foreach",
                                                                "foreach": "@outputs('Compose_for_referencedata_tag_in_XML')",
                                                                "actions": {
                                                                    "Compose_for_project_journal_line": {
                                                                        "type": "Compose",
                                                                        "inputs": "@items('For_each')",
                                                                        "runAfter": {}
                                                                    },
                                                                    "Condition_ProjCategory": {
                                                                        "type": "If",
                                                                        "expression": {
                                                                            "and": [
                                                                                {
                                                                                    "equals": [
                                                                                        "@body('Parse_JSON_for_project_journal_line')?['@code']",
                                                                                        "Project Category"
                                                                                    ]
                                                                                },
                                                                                {
                                                                                    "equals": [
                                                                                        "@variables('CountProjCat')",
                                                                                        0
                                                                                    ]
                                                                                }
                                                                            ]
                                                                        },
                                                                        "actions": {
                                                                            "Increment_projCatCount": {
                                                                                "type": "IncrementVariable",
                                                                                "inputs": {
                                                                                    "name": "CountProjCat",
                                                                                    "value": 1
                                                                                },
                                                                                "runAfter": {
                                                                                    "Set_ProjCategory": [
                                                                                        "Succeeded"
                                                                                    ]
                                                                                }
                                                                            },
                                                                            "Set_ProjCategory": {
                                                                                "type": "SetVariable",
                                                                                "inputs": {
                                                                                    "name": "ProjCat",
                                                                                    "value": "@items('For_each')?['Value']"
                                                                                },
                                                                                "runAfter": {}
                                                                            }
                                                                        },
                                                                        "runAfter": {
                                                                            "Parse_JSON_for_project_journal_line": [
                                                                                "Succeeded"
                                                                            ]
                                                                        },
                                                                        "else": {
                                                                            "actions": {
                                                                                "Set_project_description": {
                                                                                    "type": "SetVariable",
                                                                                    "inputs": {
                                                                                        "name": "PD",
                                                                                        "value": "@{items('for_each')?['Value']}"
                                                                                    },
                                                                                    "runAfter": {}
                                                                                }
                                                                            }
                                                                        }
                                                                    },
                                                                    "Parse_JSON_for_project_journal_line": {
                                                                        "type": "ParseJson",
                                                                        "inputs": {
                                                                            "content": "@outputs('Compose_for_project_journal_line')",
                                                                            "schema": {
                                                                                "properties": {
                                                                                    "@@code": {
                                                                                        "type": "string"
                                                                                    },
                                                                                    "@@name": {
                                                                                        "type": "string"
                                                                                    },
                                                                                    "@@type": {
                                                                                        "type": "string"
                                                                                    },
                                                                                    "@@typeFormat": {
                                                                                        "type": "string"
                                                                                    },
                                                                                    "Code": {
                                                                                        "type": "string"
                                                                                    },
                                                                                    "Description": {
                                                                                        "type": "string"
                                                                                    },
                                                                                    "Value": {
                                                                                        "type": "string"
                                                                                    }
                                                                                },
                                                                                "type": [
                                                                                    "object",
                                                                                    "array"
                                                                                ]
                                                                            }
                                                                        },
                                                                        "runAfter": {
                                                                            "Compose_for_project_journal_line": [
                                                                                "Succeeded"
                                                                            ]
                                                                        }
                                                                    }
                                                                },
                                                                "runAfter": {
                                                                    "Compose_for_referencedata_tag_in_XML": [
                                                                        "Succeeded"
                                                                    ]
                                                                }
                                                            },
                                                            "Condition_if_proj_cat_exists": {
                                                                "type": "If",
                                                                "expression": {
                                                                    "and": [
                                                                        {
                                                                            "greater": [
                                                                                "@length(variables('ProjCat'))",
                                                                                0
                                                                            ]
                                                                        }
                                                                    ]
                                                                },
                                                                "actions": {
                                                                    "Create_project_journal_line": {
                                                                        "type": "Http",
                                                                        "inputs": {
                                                                            "method": "POST",
                                                                            "uri": "@{concat('https://', parameters('D365FO'), '/data/HSVendInvoiceJournalLines')}",
                                                                            "body": {
                                                                                "JournalBatchNumber": "@body('Create_Header')?['JournalBatchNumber']",
                                                                                "Currency": "@body('Create_Vendor_journal_line')['Currency']",
                                                                                "dataAreaId": "@body('Create_Header')?['dataAreaId']",
                                                                                "LineNumber": "@variables('LineNum')",
                                                                                "Divison": "@variables('Division')",
                                                                                "Credit": "@if(less(variables('Total'), 0.00), mul(variables('Total'), -1), 0.00)",
                                                                                "AFENumber": "@{items('For_each_line')?['AFENumber']}",
                                                                                "MainAccountNumber": "@{items('for_each_line')?['AFENumber']}",
                                                                                "InvoiceDate": "@body('Create_Vendor_journal_line')?['InvoiceDate']",
                                                                                "Debit": "@if(greater(variables('Total'), 0.00), variables('Total'), 0.00)",
                                                                                "ProjCategoryId": "@variables('ProjCat')",
                                                                                "Description": "@variables('PD')",
                                                                                "AccountType": "Project",
                                                                                "Invoice": "@body('Create_Vendor_journal_line')?['Invoice']",
                                                                                "HSOIInvoiceId": "@body('Create_Vendor_journal_line')?['HSOIInvoiceId']",
                                                                                "Document": "@if(equals(variables('DocumentName'),null),'',variables('DocumentName'))"
                                                                            },
                                                                            "authentication": {
                                                                                "type": "ActiveDirectoryOAuth",
                                                                                "tenant": "@parameters('TenantId')",
                                                                                "audience": "@concat('https://',parameters('D365FO'))",
                                                                                "clientId": "@appSetting('D365_API_CLIENT_ID')",
                                                                                "secret": "@appsetting('D365_API_CLIENT_SECRET')"
                                                                            },
                                                                            "retryPolicy": {
                                                                                "type": "fixed",
                                                                                "count": 4,
                                                                                "interval": "PT5S"
                                                                            }
                                                                        },
                                                                        "runAfter": {}
                                                                    },
                                                                    "Increment_countProjJourLine": {
                                                                        "type": "IncrementVariable",
                                                                        "inputs": {
                                                                            "name": "CountProjectJourLine"
                                                                        },
                                                                        "runAfter": {
                                                                            "Create_project_journal_line": [
                                                                                "Succeeded"
                                                                            ]
                                                                        }
                                                                    },
                                                                    "Decrement_PrjCatCount": {
                                                                        "type": "DecrementVariable",
                                                                        "inputs": {
                                                                            "name": "CountProjCat",
                                                                            "value": 1
                                                                        },
                                                                        "runAfter": {
                                                                            "Increment_countProjJourLine": [
                                                                                "Succeeded"
                                                                            ]
                                                                        }
                                                                    },
                                                                    "Parse_project_error_message": {
                                                                        "type": "ParseJson",
                                                                        "inputs": {
                                                                            "content": "@body('Create_project_journal_line')",
                                                                            "schema": {
                                                                                "properties": {
                                                                                    "errors": {
                                                                                        "type": "array"
                                                                                    },
                                                                                    "message": {
                                                                                        "type": "string"
                                                                                    },
                                                                                    "source": {
                                                                                        "type": "string"
                                                                                    },
                                                                                    "status": {
                                                                                        "type": "number"
                                                                                    }
                                                                                },
                                                                                "type": "object"
                                                                            }
                                                                        },
                                                                        "runAfter": {
                                                                            "Create_project_journal_line": [
                                                                                "FAILED",
                                                                                "TIMEDOUT"
                                                                            ]
                                                                        }
                                                                    },
                                                                    "Set_error_messae_for_proj_line_fails": {
                                                                        "type": "SetVariable",
                                                                        "inputs": {
                                                                            "name": "errorMessage",
                                                                            "value": "@body('Parse_project_error_message')?['message']"
                                                                        },
                                                                        "runAfter": {
                                                                            "Parse_project_error_message": [
                                                                                "Succeeded"
                                                                            ]
                                                                        }
                                                                    },
                                                                    "Set_projCount": {
                                                                        "type": "SetVariable",
                                                                        "inputs": {
                                                                            "name": "CountProjectJourLine",
                                                                            "value": -1
                                                                        },
                                                                        "runAfter": {
                                                                            "Set_error_messae_for_proj_line_fails": [
                                                                                "Succeeded"
                                                                            ]
                                                                        }
                                                                    }
                                                                },
                                                                "runAfter": {
                                                                    "For_each": [
                                                                        "Succeeded"
                                                                    ]
                                                                },
                                                                "else": {
                                                                    "actions": {
                                                                        "Set_variable_3": {
                                                                            "type": "SetVariable",
                                                                            "inputs": {
                                                                                "name": "errorMessage",
                                                                                "value": "Project Category is missing for invoice @{body('Create_Vendor_journal_line')?['Invoice']}"
                                                                            },
                                                                            "runAfter": {}
                                                                        }
                                                                    }
                                                                }
                                                            }
                                                        },
                                                        "runAfter": {
                                                            "Increment_LineNum": [
                                                                "Succeeded",
                                                                "TIMEDOUT",
                                                                "SKIPPED",
                                                                "FAILED"
                                                            ]
                                                        },
                                                        "else": {
                                                            "actions": {
                                                                "Create_ledger_journal_line": {
                                                                    "type": "Http",
                                                                    "inputs": {
                                                                        "method": "POST",
                                                                        "uri": "@{concat('https://', parameters('D365FO'), '/data/HSVendInvoiceJournalLines')}",
                                                                        "body": {
                                                                            "JournalBatchNumber": "@body('Create_Header')?['JournalBatchNumber']",
                                                                            "Currency": "@body('Create_Vendor_journal_line')['Currency']",
                                                                            "dataAreaId": "@body('Create_Header')?['dataAreaId']",
                                                                            "LineNumber": "@variables('LineNum')",
                                                                            "Credit": "@if(less(variables('Total'), 0.00), mul(variables('Total'), -1), 0.00)",
                                                                            "InvoiceDate": "@body('Create_Vendor_journal_line')?['InvoiceDate']",
                                                                            "AccountDisplayValue": "@body('Get_LedgerDim')?['value']",
                                                                            "Debit": "@if(greater(variables('Total'), 0.00), variables('Total'), 0.00)",
                                                                            "Description": "@{if(equals(items('For_each_line')?['Tax']?['TaxType'],'GST'),body('Create_Vendor_journal_line')?['Invoice'],variables('referenceData'))}",
                                                                            "AccountType": "Ledger",
                                                                            "Invoice": "@body('Create_Vendor_journal_line')?['Invoice']",
                                                                            "HSOIInvoiceId": "@body('Create_Vendor_journal_line')?['HSOIInvoiceId']",
                                                                            "Document": "@if(equals(variables('DocumentName'),null),'',variables('DocumentName'))"
                                                                        },
                                                                        "authentication": {
                                                                            "type": "ActiveDirectoryOAuth",
                                                                            "tenant": "@parameters('TenantId')",
                                                                            "audience": "@concat('https://',parameters('D365FO'))",
                                                                            "clientId": "@appSetting('D365_API_CLIENT_ID')",
                                                                            "secret": "@appsetting('D365_API_CLIENT_SECRET')"
                                                                        },
                                                                        "retryPolicy": {
                                                                            "type": "fixed",
                                                                            "count": 4,
                                                                            "interval": "PT5S"
                                                                        }
                                                                    },
                                                                    "runAfter": {
                                                                        "check_if_ref_data_is_array": [
                                                                            "Succeeded"
                                                                        ]
                                                                    }
                                                                },
                                                                "Get_LedgerDim": {
                                                                    "type": "Http",
                                                                    "inputs": {
                                                                        "method": "POST",
                                                                        "uri": "@{concat('https://', parameters('D365FO'), '/data/HSVendInvoiceJournalLines/Microsoft.Dynamics.DataEntities.displayValueForLedger')}",
                                                                        "body": {
                                                                            "_mainaccountid": "@{items('For_each_line')?['AccountInformation']?['MajorAccount']?['AccountNumber']}",
                                                                            "_legalEntity": "@variables('CompanyId')",
                                                                            "_BU": "@items('For_each_line')?['AccountInformation']?['MinorAccount']?['AccountNumber']",
                                                                            "_location": "@items('For_each_line')?['AccountInformation']?['SubCode']?['AccountNumber']",
                                                                            "_division": "@variables('Division')"
                                                                        },
                                                                        "authentication": {
                                                                            "type": "ActiveDirectoryOAuth",
                                                                            "tenant": "@parameters('TenantId')",
                                                                            "audience": "@concat('https://',parameters('D365FO'))",
                                                                            "clientId": "@appSetting('D365_API_CLIENT_ID')",
                                                                            "secret": "@appsetting('D365_API_CLIENT_SECRET')"
                                                                        },
                                                                        "retryPolicy": {
                                                                            "type": "fixed",
                                                                            "count": 4,
                                                                            "interval": "PT5S"
                                                                        }
                                                                    },
                                                                    "runAfter": {}
                                                                },
                                                                "Increment_countLedJourLine": {
                                                                    "type": "IncrementVariable",
                                                                    "inputs": {
                                                                        "name": "countLedJournLine",
                                                                        "value": 1
                                                                    },
                                                                    "runAfter": {
                                                                        "Create_ledger_journal_line": [
                                                                            "Succeeded"
                                                                        ]
                                                                    }
                                                                },
                                                                "Parse_ledger_error_message": {
                                                                    "type": "ParseJson",
                                                                    "inputs": {
                                                                        "content": "@body('Create_ledger_journal_line')",
                                                                        "schema": {
                                                                            "properties": {
                                                                                "errors": {
                                                                                    "type": "array"
                                                                                },
                                                                                "message": {
                                                                                    "type": "string"
                                                                                },
                                                                                "source": {
                                                                                    "type": "string"
                                                                                },
                                                                                "status": {
                                                                                    "type": "number"
                                                                                }
                                                                            },
                                                                            "type": "object"
                                                                        }
                                                                    },
                                                                    "runAfter": {
                                                                        "Create_ledger_journal_line": [
                                                                            "TIMEDOUT",
                                                                            "SKIPPED",
                                                                            "FAILED"
                                                                        ]
                                                                    }
                                                                },
                                                                "Set_LedgerCount": {
                                                                    "type": "SetVariable",
                                                                    "inputs": {
                                                                        "name": "countLedJournLine",
                                                                        "value": -1
                                                                    },
                                                                    "runAfter": {
                                                                        "Set_error_message_on_ledger_line_fail": [
                                                                            "Succeeded"
                                                                        ]
                                                                    }
                                                                },
                                                                "Set_error_message_on_ledger_line_fail": {
                                                                    "type": "SetVariable",
                                                                    "inputs": {
                                                                        "name": "errorMessage",
                                                                        "value": "@body('Parse_ledger_error_message')?['message']"
                                                                    },
                                                                    "runAfter": {
                                                                        "Parse_ledger_error_message": [
                                                                            "SUCCEEDED"
                                                                        ]
                                                                    }
                                                                },
                                                                "check_if_ref_data_is_array": {
                                                                    "type": "If",
                                                                    "expression": {
                                                                        "and": [
                                                                            {
                                                                                "contains": [
                                                                                    "@string(items('For_each_line')?['ReferenceData'])",
                                                                                    "["
                                                                                ]
                                                                            }
                                                                        ]
                                                                    },
                                                                    "actions": {
                                                                        "Filter_array_reference_data": {
                                                                            "type": "Query",
                                                                            "inputs": {
                                                                                "from": "@items('For_each_line')?['ReferenceData']",
                                                                                "where": "@equals(item()['@code'], 'Reference Data')"
                                                                            },
                                                                            "runAfter": {}
                                                                        },
                                                                        "Set_variable": {
                                                                            "type": "SetVariable",
                                                                            "inputs": {
                                                                                "name": "referenceData",
                                                                                "value": "@{body('Filter_array_reference_data')?[0]?['value']}"
                                                                            },
                                                                            "runAfter": {
                                                                                "Filter_array_reference_data": [
                                                                                    "Succeeded"
                                                                                ]
                                                                            }
                                                                        }
                                                                    },
                                                                    "runAfter": {
                                                                        "Get_LedgerDim": [
                                                                            "Succeeded"
                                                                        ]
                                                                    },
                                                                    "else": {
                                                                        "actions": {
                                                                            "Set_variable_2": {
                                                                                "type": "SetVariable",
                                                                                "inputs": {
                                                                                    "name": "referenceData",
                                                                                    "value": "@{items('For_each_line')?['ReferenceData']?['Value']}"
                                                                                },
                                                                                "runAfter": {}
                                                                            }
                                                                        }
                                                                    }
                                                                }
                                                            }
                                                        }
                                                    },
                                                    "Get_financial_dimension_combination": {
                                                        "type": "ApiConnection",
                                                        "inputs": {
                                                            "host": {
                                                                "connection": {
                                                                    "referenceName": "sql_auditLogging"
                                                                }
                                                            },
                                                            "method": "get",
                                                            "path": "/v2/datasets/@{encodeURIComponent(encodeURIComponent(parameters('OIServerName')))},@{encodeURIComponent(encodeURIComponent(parameters('OIDBName')))}/tables/@{encodeURIComponent(encodeURIComponent('[dbo].[Dimensions_Mapping]'))}/items",
                                                            "queries": {
                                                                "$filter": "Legal_Entity eq '@{variables('CompanyId')}' and BU_Dimension eq '@{variables('ActualBU')}'"
                                                            }
                                                        },
                                                        "runAfter": {
                                                            "Set_ActualBU": [
                                                                "Succeeded"
                                                            ]
                                                        }
                                                    },
                                                    "Increment_LineNum": {
                                                        "type": "IncrementVariable",
                                                        "inputs": {
                                                            "name": "LineNum",
                                                            "value": 1
                                                        },
                                                        "runAfter": {
                                                            "Set_line_total": [
                                                                "Succeeded"
                                                            ]
                                                        }
                                                    },
                                                    "Set_ActualBU": {
                                                        "type": "SetVariable",
                                                        "inputs": {
                                                            "name": "ActualBU",
                                                            "value": "@{if(or(equals(variables('BU'),'-'),equals(variables('BU'),'')),'GST',variables('BU'))}"
                                                        },
                                                        "runAfter": {
                                                            "Set_BU": [
                                                                "Succeeded"
                                                            ]
                                                        }
                                                    },
                                                    "Set_BU": {
                                                        "type": "SetVariable",
                                                        "inputs": {
                                                            "name": "BU",
                                                            "value": "@items('For_each_line')?['AccountInformation']?['MinorAccount']?['AccountNumber']"
                                                        },
                                                        "runAfter": {
                                                            "Check_AdditionalData_element_exist": [
                                                                "Succeeded"
                                                            ]
                                                        }
                                                    },
                                                    "Set_line_total": {
                                                        "type": "SetVariable",
                                                        "inputs": {
                                                            "name": "Total",
                                                            "value": "@float(items('For_each_line')?['Total'])"
                                                        },
                                                        "runAfter": {
                                                            "Condition_to_get_division": [
                                                                "Succeeded"
                                                            ]
                                                        }
                                                    },
                                                    "Condition_to_get_division": {
                                                        "type": "If",
                                                        "expression": {
                                                            "and": [
                                                                {
                                                                    "greater": [
                                                                        "@length(body('Get_financial_dimension_combination')?['value'])",
                                                                        1
                                                                    ]
                                                                }
                                                            ]
                                                        },
                                                        "actions": {
                                                            "Get_division_for_multiBu_(V2)": {
                                                                "type": "ApiConnection",
                                                                "inputs": {
                                                                    "host": {
                                                                        "connection": {
                                                                            "referenceName": "sql_auditLogging"
                                                                        }
                                                                    },
                                                                    "method": "get",
                                                                    "path": "/v2/datasets/@{encodeURIComponent(encodeURIComponent(parameters('OIServerName')))},@{encodeURIComponent(encodeURIComponent(parameters('OIDBName')))}/tables/@{encodeURIComponent(encodeURIComponent('[dbo].[Dimensions_Mapping]'))}/items",
                                                                    "queries": {
                                                                        "$filter": "Legal_Entity eq '@{variables('CompanyId')}' and BU_Dimension eq '@{variables('ActualBU')}' and Location eq '@{variables('Location')}'"
                                                                    }
                                                                },
                                                                "runAfter": {
                                                                    "Set_Location": [
                                                                        "Succeeded"
                                                                    ]
                                                                }
                                                            },
                                                            "Set_Location": {
                                                                "type": "SetVariable",
                                                                "inputs": {
                                                                    "name": "Location",
                                                                    "value": "@{items('For_each_line')?['AccountInformation']?['SubCode']?['AccountNumber']}"
                                                                },
                                                                "runAfter": {}
                                                            },
                                                            "For_each_2": {
                                                                "type": "Foreach",
                                                                "foreach": "@body('Get_division_for_multiBu_(V2)')?['value']",
                                                                "actions": {
                                                                    "Set_Div": {
                                                                        "type": "SetVariable",
                                                                        "inputs": {
                                                                            "name": "Division",
                                                                            "value": "@items('For_each_2')?['Div_Dimension']"
                                                                        },
                                                                        "runAfter": {}
                                                                    }
                                                                },
                                                                "runAfter": {
                                                                    "Get_division_for_multiBu_(V2)": [
                                                                        "Succeeded"
                                                                    ]
                                                                }
                                                            }
                                                        },
                                                        "runAfter": {
                                                            "Get_financial_dimension_combination": [
                                                                "Succeeded"
                                                            ]
                                                        },
                                                        "else": {
                                                            "actions": {
                                                                "For_each_3": {
                                                                    "type": "Foreach",
                                                                    "foreach": "@body('Get_financial_dimension_combination')?['value']",
                                                                    "actions": {
                                                                        "Set_financial_div": {
                                                                            "type": "SetVariable",
                                                                            "inputs": {
                                                                                "name": "Division",
                                                                                "value": "@items('For_each_3')?['Div_Dimension']"
                                                                            },
                                                                            "runAfter": {}
                                                                        }
                                                                    },
                                                                    "runAfter": {}
                                                                }
                                                            }
                                                        }
                                                    },
                                                    "Check_AdditionalData_element_exist": {
                                                        "type": "If",
                                                        "expression": {
                                                            "and": [
                                                                {
                                                                    "not": {
                                                                        "equals": [
                                                                            "@items('For_each_Line')?['AdditionalData']",
                                                                            "@null"
                                                                        ]
                                                                    }
                                                                },
                                                                {
                                                                    "startsWith": [
                                                                        "@string(items('For_each_Line')?['AdditionalData'])",
                                                                        "["
                                                                    ]
                                                                }
                                                            ]
                                                        },
                                                        "actions": {
                                                            "For_each__Additional_Data": {
                                                                "type": "Foreach",
                                                                "foreach": "@items('For_Each_Line')['AdditionalData']",
                                                                "actions": {
                                                                    "Check_for_Invoice_Document": {
                                                                        "type": "If",
                                                                        "expression": {
                                                                            "and": [
                                                                                {
                                                                                    "equals": [
                                                                                        "@item()['@internal_code']",
                                                                                        "Invoice_Document"
                                                                                    ]
                                                                                }
                                                                            ]
                                                                        },
                                                                        "actions": {
                                                                            "Set_DocumentName": {
                                                                                "type": "SetVariable",
                                                                                "inputs": {
                                                                                    "name": "DocumentName",
                                                                                    "value": "@{item()['#text']}"
                                                                                },
                                                                                "runAfter": {}
                                                                            }
                                                                        },
                                                                        "runAfter": {}
                                                                    }
                                                                },
                                                                "runAfter": {}
                                                            }
                                                        },
                                                        "runAfter": {},
                                                        "else": {
                                                            "actions": {
                                                                "Set_DocumentName_variable": {
                                                                    "type": "SetVariable",
                                                                    "inputs": {
                                                                        "name": "DocumentName",
                                                                        "value": "@{if(equals(items('For_each_Line')?['AdditionalData'], null), '', if(equals(items('For_each_Line')?['AdditionalData']?['@internal_code'], 'Invoice_Document'),items('For_each_Line')?['AdditionalData']?['#text'], ''))}"
                                                                    },
                                                                    "runAfter": {}
                                                                }
                                                            }
                                                        }
                                                    }
                                                },
                                                "runAfter": {
                                                    "Reset_DocumentName_Variable": [
                                                        "Succeeded"
                                                    ]
                                                }
                                            },
                                            "Parse_JSON_line_item_details": {
                                                "type": "ParseJson",
                                                "inputs": {
                                                    "content": "@outputs('Compose_line_item_details')",
                                                    "schema": {
                                                        "properties": {
                                                            "Categorization": {
                                                                "properties": {
                                                                    "@@CategorizationScheme": {
                                                                        "type": "string"
                                                                    },
                                                                    "CategoryCode": {
                                                                        "type": "string"
                                                                    }
                                                                },
                                                                "type": "object"
                                                            },
                                                            "Coding": {
                                                                "items": {
                                                                    "properties": {
                                                                        "AFENumber": {
                                                                            "type": "string"
                                                                        },
                                                                        "AccountInformation": {
                                                                            "properties": {
                                                                                "MajorAccount": {
                                                                                    "properties": {
                                                                                        "AccountNumber": {
                                                                                            "type": "string"
                                                                                        },
                                                                                        "AccountType": {
                                                                                            "type": "string"
                                                                                        },
                                                                                        "Description": {
                                                                                            "type": "string"
                                                                                        }
                                                                                    },
                                                                                    "type": "object"
                                                                                },
                                                                                "MinorAccount": {
                                                                                    "properties": {
                                                                                        "AccountNumber": {
                                                                                            "type": "string"
                                                                                        },
                                                                                        "Description": {
                                                                                            "type": "string"
                                                                                        }
                                                                                    },
                                                                                    "type": "object"
                                                                                },
                                                                                "SubCode": {
                                                                                    "properties": {
                                                                                        "AccountNumber": {
                                                                                            "type": "string"
                                                                                        }
                                                                                    },
                                                                                    "type": "object"
                                                                                }
                                                                            },
                                                                            "type": "object"
                                                                        },
                                                                        "AdditionalData": {
                                                                            "items": {
                                                                                "properties": {
                                                                                    "#text": {
                                                                                        "type": "string"
                                                                                    },
                                                                                    "@@internal_code": {
                                                                                        "type": "string"
                                                                                    }
                                                                                },
                                                                                "required": [
                                                                                    "@@internal_code",
                                                                                    "#text"
                                                                                ],
                                                                                "type": "object"
                                                                            },
                                                                            "type": [
                                                                                "array",
                                                                                "object"
                                                                            ]
                                                                        },
                                                                        "RateOrPercentage": {
                                                                            "type": "string"
                                                                        },
                                                                        "ReferenceData": {
                                                                            "items": {
                                                                                "properties": {
                                                                                    "@@code": {
                                                                                        "type": "string"
                                                                                    },
                                                                                    "@@name": {
                                                                                        "type": "string"
                                                                                    },
                                                                                    "@@type": {
                                                                                        "type": "string"
                                                                                    },
                                                                                    "@@typeFormat": {
                                                                                        "type": "string"
                                                                                    },
                                                                                    "Code": {
                                                                                        "type": "string"
                                                                                    },
                                                                                    "Description": {
                                                                                        "type": "string"
                                                                                    },
                                                                                    "Value": {
                                                                                        "type": "string"
                                                                                    }
                                                                                },
                                                                                "required": [
                                                                                    "@@code",
                                                                                    "@@name",
                                                                                    "@@type",
                                                                                    "Value"
                                                                                ],
                                                                                "type": "object"
                                                                            },
                                                                            "type": [
                                                                                "array",
                                                                                "object"
                                                                            ]
                                                                        },
                                                                        "Tax": {
                                                                            "properties": {
                                                                                "TaxType": {
                                                                                    "type": "string"
                                                                                }
                                                                            },
                                                                            "type": "object"
                                                                        },
                                                                        "Total": {
                                                                            "type": "string"
                                                                        }
                                                                    },
                                                                    "required": [
                                                                        "RateOrPercentage",
                                                                        "Total",
                                                                        "AccountInformation"
                                                                    ],
                                                                    "type": "object"
                                                                },
                                                                "type": [
                                                                    "array",
                                                                    "object"
                                                                ]
                                                            },
                                                            "Discount": {
                                                                "properties": {
                                                                    "RateOrPercentage": {
                                                                        "type": "string"
                                                                    },
                                                                    "Total": {
                                                                        "type": "string"
                                                                    }
                                                                },
                                                                "type": "object"
                                                            },
                                                            "LineItemChargeClass": {
                                                                "type": "string"
                                                            },
                                                            "LineItemNumber": {
                                                                "type": "string"
                                                            },
                                                            "LongDescription": {
                                                                "type": "string"
                                                            },
                                                            "Quantity": {
                                                                "type": "string"
                                                            },
                                                            "UnitPrice": {
                                                                "type": "string"
                                                            }
                                                        },
                                                        "type": "object"
                                                    }
                                                },
                                                "runAfter": {
                                                    "Compose_line_item_details": [
                                                        "Succeeded"
                                                    ]
                                                }
                                            },
                                            "Filter_array": {
                                                "type": "Query",
                                                "inputs": {
                                                    "from": "@outputs('Compose_to_get_the_coding_tag_records_from_the_line_details')",
                                                    "where": "@not(equals(float(item()['Total']), 0))"
                                                },
                                                "runAfter": {
                                                    "Compose_to_get_the_coding_tag_records_from_the_line_details": [
                                                        "Succeeded"
                                                    ]
                                                }
                                            },
                                            "Reset_DocumentName_Variable": {
                                                "type": "SetVariable",
                                                "inputs": {
                                                    "name": "DocumentName",
                                                    "value": "@{null}"
                                                },
                                                "runAfter": {
                                                    "Filter_array": [
                                                        "Succeeded"
                                                    ]
                                                }
                                            }
                                        },
                                        "runAfter": {
                                            "Compose_Line_details": [
                                                "Succeeded"
                                            ]
                                        }
                                    },
                                    "Parse_Header_error_message": {
                                        "type": "ParseJson",
                                        "inputs": {
                                            "content": "@body('Create_Header')",
                                            "schema": {
                                                "properties": {
                                                    "errors": {
                                                        "type": "array"
                                                    },
                                                    "message": {
                                                        "type": "string"
                                                    },
                                                    "source": {
                                                        "type": "string"
                                                    },
                                                    "status": {
                                                        "type": "number"
                                                    }
                                                },
                                                "type": "object"
                                            }
                                        },
                                        "runAfter": {
                                            "Create_Header": [
                                                "FAILED",
                                                "TIMEDOUT",
                                                "SKIPPED"
                                            ]
                                        }
                                    },
                                    "Parse_JSON_for_vendor_error_message": {
                                        "type": "ParseJson",
                                        "inputs": {
                                            "content": "@body('Create_Vendor_journal_line')",
                                            "schema": {
                                                "type": "object",
                                                "properties": {
                                                    "error": {
                                                        "type": "object",
                                                        "properties": {
                                                            "code": {
                                                                "type": "string"
                                                            },
                                                            "message": {
                                                                "type": "string"
                                                            },
                                                            "innererror": {
                                                                "type": "object",
                                                                "properties": {
                                                                    "message": {
                                                                        "type": "string"
                                                                    },
                                                                    "type": {
                                                                        "type": "string"
                                                                    },
                                                                    "stacktrace": {
                                                                        "type": "string"
                                                                    }
                                                                }
                                                            }
                                                        }
                                                    }
                                                }
                                            }
                                        },
                                        "runAfter": {
                                            "Create_Vendor_journal_line": [
                                                "TIMEDOUT",
                                                "SKIPPED",
                                                "FAILED"
                                            ]
                                        }
                                    },
                                    "Set_Total": {
                                        "type": "SetVariable",
                                        "inputs": {
                                            "name": "Total",
                                            "value": "@float(body('Parse_JSON_invoice_details')?['SupplierConnectInvoice']?['Invoice']?['InvoiceHeader']?['Total'])"
                                        },
                                        "runAfter": {}
                                    },
                                    "Set_journalNum": {
                                        "type": "SetVariable",
                                        "inputs": {
                                            "name": "journalNum",
                                            "value": "@body('Create_Header')?['JournalBatchNumber']"
                                        },
                                        "runAfter": {
                                            "Create_Header": [
                                                "Succeeded"
                                            ]
                                        }
                                    },
                                    "Set_error_message_for_header_fail": {
                                        "type": "SetVariable",
                                        "inputs": {
                                            "name": "errorMessage",
                                            "value": "@body('Parse_Header_error_message')?['message']"
                                        },
                                        "runAfter": {
                                            "Parse_Header_error_message": [
                                                "Succeeded"
                                            ]
                                        }
                                    },
                                    "Set_error_message_on_vendor_line_fails": {
                                        "type": "SetVariable",
                                        "inputs": {
                                            "name": "errorMessage",
                                            "value": "Error:@{body('Parse_JSON_for_vendor_error_message')?['error']?['innererror']?['message']}"
                                        },
                                        "runAfter": {
                                            "Parse_JSON_for_vendor_error_message": [
                                                "Succeeded"
                                            ]
                                        }
                                    },
                                    "Execute_action_vend_Name": {
                                        "type": "Http",
                                        "inputs": {
                                            "method": "POST",
                                            "uri": "@{concat('https://', parameters('D365FO'), '/data/HSVendInvoiceJournalLines/Microsoft.Dynamics.DataEntities.getFOVendor')}",
                                            "body": {
                                                "_value": "@variables('VendAccount')",
                                                "_dataAreaId": "@variables('CompanyId')"
                                            },
                                            "authentication": {
                                                "type": "ActiveDirectoryOAuth",
                                                "tenant": "@parameters('TenantId')",
                                                "audience": "@concat('https://',parameters('D365FO'))",
                                                "clientId": "@appSetting('D365_API_CLIENT_ID')",
                                                "secret": "@appsetting('D365_API_CLIENT_SECRET')"
                                            },
                                            "retryPolicy": {
                                                "type": "fixed",
                                                "count": 4,
                                                "interval": "PT5S"
                                            }
                                        },
                                        "runAfter": {
                                            "Set_Total": [
                                                "Succeeded"
                                            ]
                                        }
                                    },
                                    "Set_vendName": {
                                        "type": "SetVariable",
                                        "inputs": {
                                            "name": "VendName",
                                            "value": "@body('Execute_action_vend_Name')?['value']"
                                        },
                                        "runAfter": {
                                            "Execute_action_vend_Name": [
                                                "Succeeded"
                                            ]
                                        }
                                    }
                                },
                                "runAfter": {
                                    "Execute_action_to_find_FO_VendAccount": [
                                        "Succeeded",
                                        "TIMEDOUT",
                                        "SKIPPED",
                                        "FAILED"
                                    ]
                                },
                                "else": {
                                    "actions": {
                                        "Set_error_message_for_invalid_vendor_account": {
                                            "type": "SetVariable",
                                            "inputs": {
                                                "name": "errorMessage",
                                                "value": "'D365 vendor number lookup failed'"
                                            },
                                            "runAfter": {}
                                        }
                                    }
                                }
                            },
                            "Execute_action_to_find_FO_VendAccount": {
                                "type": "Http",
                                "inputs": {
                                    "method": "POST",
                                    "uri": "@{concat('https://', parameters('D365FO'), '/data/HSVendInvoiceJournalLines/Microsoft.Dynamics.DataEntities.getVendAccount')}",
                                    "body": {
                                        "_value": "@variables('VendAccount')",
                                        "_dataAreaId": "@variables('CompanyId')"
                                    },
                                    "authentication": {
                                        "type": "ActiveDirectoryOAuth",
                                        "tenant": "@parameters('TenantId')",
                                        "audience": "@concat('https://',parameters('D365FO'))",
                                        "clientId": "@appSetting('D365_API_CLIENT_ID')",
                                        "secret": "@appsetting('D365_API_CLIENT_SECRET')"
                                    },
                                    "retryPolicy": {
                                        "type": "fixed",
                                        "count": 4,
                                        "interval": "PT5S"
                                    }
                                },
                                "runAfter": {
                                    "Increment_VendCount": [
                                        "Succeeded"
                                    ]
                                }
                            },
                            "Increment_VendCount": {
                                "type": "IncrementVariable",
                                "inputs": {
                                    "name": "VendCount",
                                    "value": 1
                                },
                                "runAfter": {
                                    "Set_VendAccount": [
                                        "Succeeded"
                                    ]
                                }
                            },
                            "Set_VendAccount": {
                                "type": "SetVariable",
                                "inputs": {
                                    "name": "VendAccount",
                                    "value": "@items('For_each_on_Partner_to_find_Vendor')?['Site']?['SiteCode']?['#text']"
                                },
                                "runAfter": {}
                            }
                        },
                        "runAfter": {}
                    }
                },
                "runAfter": {
                    "Set_variable_legal_entity": [
                        "Succeeded"
                    ]
                },
                "runtimeConfiguration": {
                    "concurrency": {
                        "repetitions": 1
                    }
                }
            },
            "HTTP_request_for_OIinvoice_details": {
                "type": "Http",
                "inputs": {
                    "method": "GET",
                    "uri": "@{parameters('OIUrl')}/docp/supply-chain/v1/invoices/@{body('Parse_JSON_imageinvoiceId')?['ImageInvoiceId']}",
                    "authentication": {
                        "type": "ClientCertificate",
                        "pfx": "@appSetting('OPEN_INVOICE_API_CERT')",
                        "password": "@appSetting('OPEN_INVOICE_API_CERT_PASSWORD')"
                    }
                },
                "runAfter": {
                    "Condition_2": [
                        "Succeeded"
                    ]
                }
            },
            "Initialize_ActualBU": {
                "type": "InitializeVariable",
                "inputs": {
                    "variables": [
                        {
                            "name": "ActualBU",
                            "type": "string"
                        }
                    ]
                },
                "runAfter": {
                    "Initialize_BU": [
                        "Succeeded"
                    ]
                }
            },
            "Initialize_BU": {
                "type": "InitializeVariable",
                "inputs": {
                    "variables": [
                        {
                            "name": "BU",
                            "type": "string"
                        }
                    ]
                },
                "runAfter": {
                    "Initialize_project_description": [
                        "Succeeded"
                    ]
                }
            },
            "Initialize_CompanyId": {
                "type": "InitializeVariable",
                "inputs": {
                    "variables": [
                        {
                            "name": "CompanyId",
                            "type": "string"
                        }
                    ]
                },
                "runAfter": {
                    "Initialize_journalNum": [
                        "Succeeded"
                    ]
                }
            },
            "Initialize_Divsion": {
                "type": "InitializeVariable",
                "inputs": {
                    "variables": [
                        {
                            "name": "Division",
                            "type": "string"
                        }
                    ]
                },
                "runAfter": {
                    "Initialize_ActualBU": [
                        "Succeeded"
                    ]
                }
            },
            "Initialize_LineDescription": {
                "type": "InitializeVariable",
                "inputs": {
                    "variables": [
                        {
                            "name": "LineDescription",
                            "type": "string"
                        }
                    ]
                },
                "runAfter": {
                    "Initialize_Divsion": [
                        "Succeeded"
                    ]
                }
            },
            "Initialize_LineNum": {
                "type": "InitializeVariable",
                "inputs": {
                    "variables": [
                        {
                            "name": "LineNum",
                            "type": "integer",
                            "value": 1
                        }
                    ]
                },
                "runAfter": {
                    "Initialize_errorMessage": [
                        "Succeeded"
                    ]
                }
            },
            "Initialize_LocationPath": {
                "type": "InitializeVariable",
                "inputs": {
                    "variables": [
                        {
                            "name": "LocationPath",
                            "type": "string"
                        }
                    ]
                },
                "runAfter": {
                    "Initialize_PO_tag": [
                        "Succeeded"
                    ]
                }
            },
            "Initialize_PO_tag": {
                "type": "InitializeVariable",
                "inputs": {
                    "variables": [
                        {
                            "name": "PO",
                            "type": "string"
                        }
                    ]
                },
                "runAfter": {
                    "Initialize_projCategory": [
                        "Succeeded"
                    ]
                }
            },
            "Initialize_ProjCatCount": {
                "type": "InitializeVariable",
                "inputs": {
                    "variables": [
                        {
                            "name": "CountProjCat",
                            "type": "integer"
                        }
                    ]
                },
                "runAfter": {
                    "Initialize_SupplierCount": [
                        "Succeeded"
                    ]
                }
            },
            "Initialize_SupplierCount": {
                "type": "InitializeVariable",
                "inputs": {
                    "variables": [
                        {
                            "name": "VendCount",
                            "type": "integer"
                        }
                    ]
                },
                "runAfter": {
                    "Initialize_LineNum": [
                        "Succeeded"
                    ]
                }
            },
            "Initialize_Total": {
                "type": "InitializeVariable",
                "inputs": {
                    "variables": [
                        {
                            "name": "Total",
                            "type": "float"
                        }
                    ]
                },
                "runAfter": {
                    "Initialize_content": [
                        "Succeeded"
                    ]
                }
            },
            "Initialize_UniversalResourceIdentifier": {
                "type": "InitializeVariable",
                "inputs": {
                    "variables": [
                        {
                            "name": "UniversalResourceIdentifier",
                            "type": "string"
                        }
                    ]
                },
                "runAfter": {
                    "Initialize_DocumentName": [
                        "Succeeded"
                    ]
                }
            },
            "Initialize_VendAccount": {
                "type": "InitializeVariable",
                "inputs": {
                    "variables": [
                        {
                            "name": "VendAccount",
                            "type": "string"
                        }
                    ]
                },
                "runAfter": {
                    "Initialize_LineDescription": [
                        "Succeeded"
                    ]
                }
            },
            "Initialize_content": {
                "type": "InitializeVariable",
                "inputs": {
                    "variables": [
                        {
                            "name": "content",
                            "type": "string"
                        }
                    ]
                },
                "runAfter": {
                    "Initialize_errorLog": [
                        "Succeeded"
                    ]
                }
            },
            "Initialize_countLedJournLine": {
                "type": "InitializeVariable",
                "inputs": {
                    "variables": [
                        {
                            "name": "countLedJournLine",
                            "type": "integer",
                            "value": 1
                        }
                    ]
                },
                "runAfter": {
                    "Initialize_countProjJourLine": [
                        "Succeeded"
                    ]
                }
            },
            "Initialize_countProjJourLine": {
                "type": "InitializeVariable",
                "inputs": {
                    "variables": [
                        {
                            "name": "CountProjectJourLine",
                            "type": "integer",
                            "value": 1
                        }
                    ]
                },
                "runAfter": {
                    "Initialize_VendAccount": [
                        "Succeeded"
                    ]
                }
            },
            "Initialize_errorMessage": {
                "type": "InitializeVariable",
                "inputs": {
                    "variables": [
                        {
                            "name": "errorMessage",
                            "type": "string"
                        }
                    ]
                },
                "runAfter": {
                    "Initialize_Total": [
                        "Succeeded"
                    ]
                }
            },
            "Initialize_imageinvoiceId": {
                "type": "InitializeVariable",
                "inputs": {
                    "variables": [
                        {
                            "name": "ImageinvoiceId",
                            "type": "string",
                            "value": "@body('Parse_JSON_imageinvoiceId')?['ImageInvoiceId']"
                        }
                    ]
                },
                "runAfter": {
                    "Parse_JSON_imageinvoiceId": [
                        "Succeeded"
                    ]
                }
            },
            "Initialize_journalNum": {
                "type": "InitializeVariable",
                "inputs": {
                    "variables": [
                        {
                            "name": "journalNum",
                            "type": "string"
                        }
                    ]
                },
                "runAfter": {
                    "Initialize_FileCount": [
                        "Succeeded"
                    ]
                }
            },
            "Initialize_projCategory": {
                "type": "InitializeVariable",
                "inputs": {
                    "variables": [
                        {
                            "name": "ProjCat",
                            "type": "string"
                        }
                    ]
                },
                "runAfter": {
                    "Initialize_CompanyId": [
                        "Succeeded"
                    ]
                }
            },
            "Initialize_Companycount": {
                "type": "InitializeVariable",
                "inputs": {
                    "variables": [
                        {
                            "name": "countCompany",
                            "type": "integer"
                        }
                    ]
                },
                "runAfter": {
                    "Initialize_retryCondition": [
                        "Succeeded"
                    ]
                }
            },
            "Parse_JSON_imageinvoiceId": {
                "type": "ParseJson",
                "inputs": {
                    "content": "@outputs('Convert_base64_content_from_primary_SB')",
                    "schema": {
                        "properties": {
                            "ImageInvoiceId": {
                                "type": "string"
                            }
                        },
                        "type": "object"
                    }
                },
                "runAfter": {
                    "Convert_base64_content_from_primary_SB": [
                        "Succeeded"
                    ]
                }
            },
            "Parse_JSON_for_VendAccount": {
                "type": "ParseJson",
                "inputs": {
                    "content": "@outputs('Compose_For_VendAccount')",
                    "schema": {
                        "items": {
                            "properties": {
                                "@@PartnerType": {
                                    "type": "string"
                                },
                                "Company": {
                                    "properties": {
                                        "CompanyCode": {
                                            "items": {
                                                "properties": {
                                                    "#text": {
                                                        "type": "string"
                                                    },
                                                    "@@CompanyCodeType": {
                                                        "type": "string"
                                                    }
                                                },
                                                "required": [
                                                    "@@CompanyCodeType",
                                                    "#text"
                                                ],
                                                "type": "object"
                                            },
                                            "type": [
                                                "array",
                                                "object"
                                            ]
                                        },
                                        "CompanyName": {
                                            "type": "string"
                                        }
                                    },
                                    "type": "object"
                                },
                                "Site": {
                                    "properties": {
                                        "Address": {
                                            "properties": {
                                                "@@AddressType": {
                                                    "type": "string"
                                                },
                                                "AddressLine": {
                                                    "items": {
                                                        "type": [
                                                            "string",
                                                            "null"
                                                        ]
                                                    },
                                                    "type": [
                                                        "array",
                                                        "object",
                                                        "string"
                                                    ]
                                                },
                                                "City": {
                                                    "type": "string"
                                                },
                                                "Country": {
                                                    "type": "string"
                                                },
                                                "CountryCode": {
                                                    "type": "string"
                                                },
                                                "EmailAddress": {
                                                    "type": "string"
                                                },
                                                "PhoneNumber": {
                                                    "properties": {
                                                        "#text": {
                                                            "type": "string"
                                                        },
                                                        "@@PhoneNumberType": {
                                                            "type": "string"
                                                        }
                                                    },
                                                    "type": [
                                                        "object",
                                                        "array"
                                                    ]
                                                },
                                                "PostalZipCode": {
                                                    "type": "string"
                                                },
                                                "StateProvince": {
                                                    "type": "string"
                                                },
                                                "StateProvinceCode": {
                                                    "type": "string"
                                                }
                                            },
                                            "type": "object"
                                        },
                                        "SiteCode": {
                                            "properties": {
                                                "#text": {
                                                    "type": "string"
                                                },
                                                "@@SiteCodeType": {
                                                    "type": "string"
                                                }
                                            },
                                            "type": "object"
                                        },
                                        "SiteName": {
                                            "type": "string"
                                        }
                                    },
                                    "type": "object"
                                }
                            },
                            "required": [
                                "@@PartnerType",
                                "Company",
                                "Site"
                            ],
                            "type": "object"
                        },
                        "type": "array"
                    }
                },
                "runAfter": {
                    "Compose_For_VendAccount": [
                        "Succeeded"
                    ]
                }
            },
            "Parse_JSON_invoice_details": {
                "type": "ParseJson",
                "inputs": {
                    "content": "@outputs('Compose_xml_to_json')",
                    "schema": {
                        "properties": {
                            "?xml": {
                                "properties": {
                                    "@@encoding": {
                                        "type": "string"
                                    },
                                    "@@version": {
                                        "type": "string"
                                    }
                                },
                                "type": "object"
                            },
                            "SupplierConnectInvoice": {
                                "properties": {
                                    "@@type": {
                                        "type": "string"
                                    },
                                    "@@xmlns": {
                                        "type": "string"
                                    },
                                    "AttachmentsReference": {
                                        "properties": {
                                            "@@numOfAttachments": {
                                                "type": "string"
                                            },
                                            "Attachment": {
                                                "items": {
                                                    "properties": {
                                                        "@@id": {
                                                            "type": "string"
                                                        },
                                                        "@@type": {
                                                            "type": "string"
                                                        },
                                                        "ClientAttachmentPath": {},
                                                        "ContentType": {
                                                            "type": "string"
                                                        },
                                                        "LocationPath": {
                                                            "type": "string"
                                                        },
                                                        "UniversalResourceIdentifier": {
                                                            "type": "string"
                                                        }
                                                    },
                                                    "required": [
                                                        "@@type",
                                                        "@@id",
                                                        "LocationPath",
                                                        "ContentType",
                                                        "ClientAttachmentPath",
                                                        "UniversalResourceIdentifier"
                                                    ],
                                                    "type": "object"
                                                },
                                                "type": "array"
                                            }
                                        },
                                        "type": "object"
                                    },
                                    "Invoice": {
                                        "properties": {
                                            "@@id": {
                                                "type": "string"
                                            },
                                            "InvoiceDetails": {
                                                "properties": {
                                                    "Coding": {
                                                        "items": {
                                                            "properties": {
                                                                "AFENumber": {
                                                                    "type": "string"
                                                                },
                                                                "AccountInformation": {
                                                                    "properties": {
                                                                        "MajorAccount": {
                                                                            "properties": {
                                                                                "AccountNumber": {
                                                                                    "type": "string"
                                                                                },
                                                                                "AccountType": {
                                                                                    "type": "string"
                                                                                },
                                                                                "Description": {
                                                                                    "type": "string"
                                                                                }
                                                                            },
                                                                            "type": "object"
                                                                        },
                                                                        "MinorAccount": {
                                                                            "properties": {
                                                                                "AccountNumber": {
                                                                                    "type": "string"
                                                                                },
                                                                                "Description": {
                                                                                    "type": "string"
                                                                                }
                                                                            },
                                                                            "type": "object"
                                                                        },
                                                                        "SubCode": {
                                                                            "properties": {
                                                                                "AccountNumber": {
                                                                                    "type": "string"
                                                                                }
                                                                            },
                                                                            "type": "object"
                                                                        }
                                                                    },
                                                                    "type": "object"
                                                                },
                                                                "AdditionalData": {
                                                                    "items": {
                                                                        "properties": {
                                                                            "#text": {
                                                                                "type": "string"
                                                                            },
                                                                            "@@internal_code": {
                                                                                "type": "string"
                                                                            }
                                                                        },
                                                                        "required": [
                                                                            "@@internal_code",
                                                                            "#text"
                                                                        ],
                                                                        "type": "object"
                                                                    },
                                                                    "type": [
                                                                        "array",
                                                                        "object"
                                                                    ]
                                                                },
                                                                "RateOrPercentage": {
                                                                    "type": "string"
                                                                },
                                                                "ReferenceData": {
                                                                    "items": {
                                                                        "properties": {
                                                                            "@@code": {
                                                                                "type": "string"
                                                                            },
                                                                            "@@name": {
                                                                                "type": "string"
                                                                            },
                                                                            "@@type": {
                                                                                "type": "string"
                                                                            },
                                                                            "@@typeFormat": {
                                                                                "type": "string"
                                                                            },
                                                                            "Code": {
                                                                                "type": "string"
                                                                            },
                                                                            "Description": {
                                                                                "type": "string"
                                                                            },
                                                                            "Value": {
                                                                                "type": "string"
                                                                            }
                                                                        },
                                                                        "required": [
                                                                            "@@code",
                                                                            "@@name",
                                                                            "@@type",
                                                                            "Value"
                                                                        ],
                                                                        "type": "object"
                                                                    },
                                                                    "type": [
                                                                        "array",
                                                                        "object"
                                                                    ]
                                                                },
                                                                "Tax": {
                                                                    "properties": {
                                                                        "TaxType": {
                                                                            "type": "string"
                                                                        }
                                                                    },
                                                                    "type": "object"
                                                                },
                                                                "Total": {
                                                                    "type": "string"
                                                                }
                                                            },
                                                            "required": [
                                                                "RateOrPercentage",
                                                                "Total",
                                                                "AccountInformation"
                                                            ],
                                                            "type": "object"
                                                        },
                                                        "type": [
                                                            "array",
                                                            "object"
                                                        ]
                                                    },
                                                    "LineItem": {
                                                        "properties": {
                                                            "Categorization": {
                                                                "properties": {
                                                                    "@@CategorizationScheme": {
                                                                        "type": "string"
                                                                    },
                                                                    "CategoryCode": {
                                                                        "type": "string"
                                                                    }
                                                                },
                                                                "type": "object"
                                                            },
                                                            "Coding": {
                                                                "items": {
                                                                    "properties": {
                                                                        "AFENumber": {
                                                                            "type": "string"
                                                                        },
                                                                        "AccountInformation": {
                                                                            "properties": {
                                                                                "MajorAccount": {
                                                                                    "properties": {
                                                                                        "AccountNumber": {
                                                                                            "type": "string"
                                                                                        },
                                                                                        "AccountType": {
                                                                                            "type": "string"
                                                                                        },
                                                                                        "Description": {
                                                                                            "type": "string"
                                                                                        }
                                                                                    },
                                                                                    "type": "object"
                                                                                },
                                                                                "MinorAccount": {
                                                                                    "properties": {
                                                                                        "AccountNumber": {
                                                                                            "type": "string"
                                                                                        },
                                                                                        "Description": {
                                                                                            "type": "string"
                                                                                        }
                                                                                    },
                                                                                    "type": "object"
                                                                                },
                                                                                "SubCode": {
                                                                                    "properties": {
                                                                                        "AccountNumber": {
                                                                                            "type": "string"
                                                                                        }
                                                                                    },
                                                                                    "type": "object"
                                                                                }
                                                                            },
                                                                            "type": "object"
                                                                        },
                                                                        "AdditionalData": {
                                                                            "items": {
                                                                                "properties": {
                                                                                    "#text": {
                                                                                        "type": "string"
                                                                                    },
                                                                                    "@@internal_code": {
                                                                                        "type": "string"
                                                                                    }
                                                                                },
                                                                                "required": [
                                                                                    "@@internal_code",
                                                                                    "#text"
                                                                                ],
                                                                                "type": "object"
                                                                            },
                                                                            "type": [
                                                                                "array",
                                                                                "object"
                                                                            ]
                                                                        },
                                                                        "RateOrPercentage": {
                                                                            "type": "string"
                                                                        },
                                                                        "ReferenceData": {
                                                                            "items": {
                                                                                "properties": {
                                                                                    "@@code": {
                                                                                        "type": "string"
                                                                                    },
                                                                                    "@@name": {
                                                                                        "type": "string"
                                                                                    },
                                                                                    "@@type": {
                                                                                        "type": "string"
                                                                                    },
                                                                                    "@@typeFormat": {
                                                                                        "type": "string"
                                                                                    },
                                                                                    "Code": {
                                                                                        "type": "string"
                                                                                    },
                                                                                    "Description": {
                                                                                        "type": "string"
                                                                                    },
                                                                                    "Value": {
                                                                                        "type": "string"
                                                                                    }
                                                                                },
                                                                                "required": [
                                                                                    "@@code",
                                                                                    "@@name",
                                                                                    "@@type",
                                                                                    "Value"
                                                                                ],
                                                                                "type": "object"
                                                                            },
                                                                            "type": [
                                                                                "array",
                                                                                "object"
                                                                            ]
                                                                        },
                                                                        "Tax": {
                                                                            "properties": {
                                                                                "TaxType": {
                                                                                    "type": "string"
                                                                                }
                                                                            },
                                                                            "type": "object"
                                                                        },
                                                                        "Total": {
                                                                            "type": "string"
                                                                        }
                                                                    },
                                                                    "required": [
                                                                        "RateOrPercentage",
                                                                        "Total",
                                                                        "AccountInformation"
                                                                    ],
                                                                    "type": "object"
                                                                },
                                                                "type": [
                                                                    "array",
                                                                    "object"
                                                                ]
                                                            },
                                                            "Discount": {
                                                                "properties": {
                                                                    "RateOrPercentage": {
                                                                        "type": "string"
                                                                    },
                                                                    "Total": {
                                                                        "type": "string"
                                                                    }
                                                                },
                                                                "type": "object"
                                                            },
                                                            "LineItemChargeClass": {
                                                                "type": "string"
                                                            },
                                                            "LineItemNumber": {
                                                                "type": "string"
                                                            },
                                                            "LongDescription": {
                                                                "type": "string"
                                                            },
                                                            "Quantity": {
                                                                "type": "string"
                                                            },
                                                            "UnitPrice": {
                                                                "type": "string"
                                                            }
                                                        },
                                                        "type": [
                                                            "object",
                                                            "array"
                                                        ]
                                                    }
                                                },
                                                "type": "object"
                                            },
                                            "InvoiceHeader": {
                                                "properties": {
                                                    "AdditionalData": {
                                                        "properties": {
                                                            "#text": {
                                                                "type": "string"
                                                            },
                                                            "@@internal_code": {
                                                                "type": "string"
                                                            }
                                                        },
                                                        "type": "object"
                                                    },
                                                    "CurrencyCode": {
                                                        "type": "string"
                                                    },
                                                    "CurrentOwner": {
                                                        "properties": {
                                                            "Person": {
                                                                "properties": {
                                                                    "@@Role": {
                                                                        "type": "string"
                                                                    },
                                                                    "EmailAddress": {
                                                                        "type": "string"
                                                                    },
                                                                    "FirstName": {
                                                                        "type": "string"
                                                                    },
                                                                    "LastName": {
                                                                        "type": "string"
                                                                    },
                                                                    "PersonIdentifier": {
                                                                        "properties": {
                                                                            "#text": {
                                                                                "type": "string"
                                                                            },
                                                                            "@@PersonIdentifierType": {
                                                                                "type": "string"
                                                                            }
                                                                        },
                                                                        "type": "object"
                                                                    }
                                                                },
                                                                "type": "object"
                                                            }
                                                        },
                                                        "type": "object"
                                                    },
                                                    "DiscountTotal": {
                                                        "type": "string"
                                                    },
                                                    "DocumentAction": {
                                                        "items": {
                                                            "properties": {
                                                                "ActionDestination": {
                                                                    "properties": {
                                                                        "DepartmentOrGroup": {
                                                                            "properties": {
                                                                                "DepartmentName": {
                                                                                    "type": "string"
                                                                                },
                                                                                "Description": {
                                                                                    "type": "string"
                                                                                }
                                                                            },
                                                                            "type": "object"
                                                                        },
                                                                        "EmailAddress": {
                                                                            "type": "string"
                                                                        },
                                                                        "FirstName": {
                                                                            "type": "string"
                                                                        },
                                                                        "LastName": {
                                                                            "type": "string"
                                                                        },
                                                                        "PersonIdentifier": {
                                                                            "properties": {
                                                                                "#text": {
                                                                                    "type": "string"
                                                                                },
                                                                                "@@personIdentifierIndicator": {
                                                                                    "type": "string"
                                                                                }
                                                                            },
                                                                            "type": "object"
                                                                        },
                                                                        "Site": {
                                                                            "properties": {
                                                                                "SiteCode": {
                                                                                    "properties": {
                                                                                        "#text": {
                                                                                            "type": "string"
                                                                                        },
                                                                                        "@@siteCodeIndicator": {
                                                                                            "type": "string"
                                                                                        }
                                                                                    },
                                                                                    "type": "object"
                                                                                },
                                                                                "SiteName": {
                                                                                    "type": "string"
                                                                                }
                                                                            },
                                                                            "type": "object"
                                                                        }
                                                                    },
                                                                    "type": "object"
                                                                },
                                                                "ActionSource": {
                                                                    "properties": {
                                                                        "@@role": {
                                                                            "type": "string"
                                                                        },
                                                                        "DepartmentOrGroup": {
                                                                            "properties": {
                                                                                "DepartmentName": {
                                                                                    "type": "string"
                                                                                },
                                                                                "Description": {
                                                                                    "type": "string"
                                                                                }
                                                                            },
                                                                            "type": "object"
                                                                        },
                                                                        "EmailAddress": {
                                                                            "type": "string"
                                                                        },
                                                                        "FirstName": {
                                                                            "type": "string"
                                                                        },
                                                                        "LastName": {
                                                                            "type": "string"
                                                                        },
                                                                        "Site": {
                                                                            "properties": {
                                                                                "SiteCode": {
                                                                                    "properties": {
                                                                                        "#text": {
                                                                                            "type": "string"
                                                                                        },
                                                                                        "@@siteCodeIndicator": {
                                                                                            "type": "string"
                                                                                        }
                                                                                    },
                                                                                    "type": "object"
                                                                                },
                                                                                "SiteName": {
                                                                                    "type": "string"
                                                                                }
                                                                            },
                                                                            "type": "object"
                                                                        }
                                                                    },
                                                                    "type": "object"
                                                                },
                                                                "ActionType": {
                                                                    "type": "string"
                                                                },
                                                                "LongDescription": {
                                                                    "type": "string"
                                                                },
                                                                "Person": {
                                                                    "properties": {
                                                                        "@@Role": {
                                                                            "type": "string"
                                                                        },
                                                                        "DepartmentOrGroup": {
                                                                            "properties": {
                                                                                "DepartmentName": {
                                                                                    "type": "string"
                                                                                },
                                                                                "Description": {
                                                                                    "type": "string"
                                                                                }
                                                                            },
                                                                            "type": "object"
                                                                        },
                                                                        "EmailAddress": {
                                                                            "type": "string"
                                                                        },
                                                                        "FirstName": {
                                                                            "type": "string"
                                                                        },
                                                                        "LastName": {
                                                                            "type": "string"
                                                                        },
                                                                        "Site": {
                                                                            "properties": {
                                                                                "SiteCode": {
                                                                                    "properties": {
                                                                                        "#text": {
                                                                                            "type": "string"
                                                                                        },
                                                                                        "@@SiteCodeType": {
                                                                                            "type": "string"
                                                                                        }
                                                                                    },
                                                                                    "type": "object"
                                                                                },
                                                                                "SiteName": {
                                                                                    "type": "string"
                                                                                }
                                                                            },
                                                                            "type": "object"
                                                                        }
                                                                    },
                                                                    "type": "object"
                                                                },
                                                                "Status": {
                                                                    "type": "string"
                                                                },
                                                                "TransactionDateTime": {
                                                                    "type": "string"
                                                                },
                                                                "TransactionIdentifier": {
                                                                    "type": "string"
                                                                }
                                                            },
                                                            "required": [
                                                                "Person",
                                                                "ActionType",
                                                                "Status",
                                                                "TransactionDateTime",
                                                                "TransactionIdentifier",
                                                                "ActionSource"
                                                            ],
                                                            "type": "object"
                                                        },
                                                        "type": "array"
                                                    },
                                                    "InvoiceDate": {
                                                        "type": "string"
                                                    },
                                                    "InvoiceNumber": {
                                                        "type": "string"
                                                    },
                                                    "InvoiceType": {
                                                        "type": "string"
                                                    },
                                                    "LongDescription": {
                                                        "type": "string"
                                                    },
                                                    "Partner": {
                                                        "items": {
                                                            "properties": {
                                                                "@@PartnerType": {
                                                                    "type": "string"
                                                                },
                                                                "Company": {
                                                                    "properties": {
                                                                        "CompanyCode": {
                                                                            "properties": {
                                                                                "#text": {
                                                                                    "type": "string"
                                                                                },
                                                                                "@@CompanyCodeType": {
                                                                                    "type": "string"
                                                                                }
                                                                            },
                                                                            "type": [
                                                                                "object",
                                                                                "array"
                                                                            ]
                                                                        },
                                                                        "CompanyName": {
                                                                            "type": "string"
                                                                        }
                                                                    },
                                                                    "type": "object"
                                                                },
                                                                "Site": {
                                                                    "properties": {
                                                                        "Address": {
                                                                            "properties": {
                                                                                "@@AddressType": {
                                                                                    "type": "string"
                                                                                },
                                                                                "AddressLine": {
                                                                                    "type": [
                                                                                        "string",
                                                                                        "array"
                                                                                    ]
                                                                                },
                                                                                "City": {
                                                                                    "type": "string"
                                                                                },
                                                                                "Country": {
                                                                                    "type": "string"
                                                                                },
                                                                                "CountryCode": {
                                                                                    "type": "string"
                                                                                },
                                                                                "PostalZipCode": {
                                                                                    "type": "string"
                                                                                },
                                                                                "StateProvince": {
                                                                                    "type": "string"
                                                                                },
                                                                                "StateProvinceCode": {
                                                                                    "type": "string"
                                                                                }
                                                                            },
                                                                            "type": [
                                                                                "object",
                                                                                "array"
                                                                            ]
                                                                        },
                                                                        "SiteCode": {
                                                                            "properties": {
                                                                                "#text": {
                                                                                    "type": "string"
                                                                                },
                                                                                "@@SiteCodeType": {
                                                                                    "type": "string"
                                                                                }
                                                                            },
                                                                            "type": "object"
                                                                        },
                                                                        "SiteName": {
                                                                            "type": "string"
                                                                        }
                                                                    },
                                                                    "type": "object"
                                                                }
                                                            },
                                                            "required": [
                                                                "@@PartnerType",
                                                                "Company",
                                                                "Site"
                                                            ],
                                                            "type": "object"
                                                        },
                                                        "type": "array"
                                                    },
                                                    "ReferenceData": {
                                                        "properties": {
                                                            "@@code": {
                                                                "type": "string"
                                                            },
                                                            "@@name": {
                                                                "type": "string"
                                                            },
                                                            "@@type": {
                                                                "type": "string"
                                                            },
                                                            "Value": {
                                                                "type": "string"
                                                            }
                                                        },
                                                        "type": "object"
                                                    },
                                                    "SubmittedTotal": {
                                                        "type": "string"
                                                    },
                                                    "Total": {
                                                        "type": "string"
                                                    },
                                                    "TotalLineItems": {
                                                        "type": "string"
                                                    },
                                                    "TransportClass": {
                                                        "type": "string"
                                                    }
                                                },
                                                "type": "object"
                                            }
                                        },
                                        "type": "object"
                                    }
                                },
                                "type": "object"
                            }
                        },
                        "type": "object"
                    }
                },
                "runAfter": {
                    "Compose_xml_to_json": [
                        "Succeeded"
                    ]
                }
            },
            "Initialize_project_description": {
                "type": "InitializeVariable",
                "inputs": {
                    "variables": [
                        {
                            "name": "PD",
                            "type": "string"
                        }
                    ]
                },
                "runAfter": {
                    "Initialize_FileType": [
                        "Succeeded"
                    ]
                }
            },
            "Get_latest_error_log": {
                "type": "ApiConnection",
                "inputs": {
                    "host": {
                        "connection": {
                            "referenceName": "sql_auditLogging"
                        }
                    },
                    "method": "get",
                    "path": "/v2/datasets/@{encodeURIComponent(encodeURIComponent(parameters('APCertifyServerName')))},@{encodeURIComponent(encodeURIComponent(parameters('APCertifyDatabaseName')))}/tables/@{encodeURIComponent(encodeURIComponent('[dbo].[D365APInvoiceAudit]'))}/items",
                    "queries": {
                        "$filter": "OIDocumentID eq '@{body('Parse_JSON_invoice_details')?['SupplierConnectInvoice']?['Invoice']?['@id']}' and WORKFLOW eq 'sb-http-d365fo-oiInvoice-createJournal'",
                        "$orderby": "recordId desc",
                        "$top": 1
                    }
                },
                "runAfter": {
                    "Parse_JSON_invoice_details": [
                        "Succeeded"
                    ]
                }
            },
            "Initialize_retryCondition": {
                "type": "InitializeVariable",
                "inputs": {
                    "variables": [
                        {
                            "name": "RetryCondition",
                            "type": "string",
                            "value": "False"
                        }
                    ]
                },
                "runAfter": {}
            },
            "Condition_for_invoiceDate": {
                "type": "If",
                "expression": {
                    "or": [
                        {
                            "greater": [
                                "@body('Parse_JSON_invoice_details')?['SupplierConnectInvoice']?['Invoice']?['InvoiceHeader']?['InvoiceDate']",
                                "@convertFromUtc(utcNow(),'Mountain Standard Time')"
                            ]
                        },
                        {
                            "not": {
                                "equals": [
                                    "@body('Parse_JSON_invoice_details')?['SupplierConnectInvoice']?['Invoice']?['InvoiceHeader']?['DocumentAction']?[0]?['Status']",
                                    "Approved"
                                ]
                            }
                        }
                    ]
                },
                "actions": {
                    "Set_variable_retry": {
                        "type": "SetVariable",
                        "inputs": {
                            "name": "RetryCondition",
                            "value": "True"
                        },
                        "runAfter": {}
                    },
                    "Send_message_to_retry_queue": {
                        "type": "ServiceProvider",
                        "inputs": {
                            "parameters": {
                                "entityName": "open-invoice-retry",
                                "message": {
                                    "contentData": {
                                        "ImageInvoiceId": "@variables('ImageinvoiceId')",
                                        "InvoiceDate": "@{body('Parse_JSON_invoice_details')?['SupplierConnectInvoice']?['Invoice']?['InvoiceHeader']?['InvoiceDate']}"
                                    },
                                    "contentType": "text/plain"
                                }
                            },
                            "serviceProviderConfiguration": {
                                "connectionName": "PrivateServiceBus",
                                "operationId": "sendMessage",
                                "serviceProviderId": "/serviceProviders/serviceBus"
                            }
                        },
                        "runAfter": {
                            "Set_variable_retry": [
                                "Succeeded"
                            ]
                        }
                    },
                    "Terminate_as_future_dated_invoice": {
                        "type": "Terminate",
                        "inputs": {
                            "runStatus": "Cancelled"
                        },
                        "runAfter": {
                            "Send_message_to_OI_invoice_skipped": [
                                "Succeeded"
                            ]
                        }
                    },
                    "Send_message_audit_error": {
                        "type": "ServiceProvider",
                        "inputs": {
                            "parameters": {
                                "entityName": "open-invoice-audit",
                                "message": {
                                    "contentData": {
                                        "D365AttachmentAdded": "",
                                        "D365JENumber": "",
                                        "D365JournalCreated": "0",
                                        "D365JournalPosted": "0",
                                        "InRetryQueue": "",
                                        "LastUpdated": "@convertFromUtc(utcNow(), 'Mountain Standard Time')",
                                        "MessageBody": "D365 journal creaation skipped due to invoice date being in future or invoice is not in approved state",
                                        "OIApproved": "0",
                                        "OIDocDataRetrieved": "",
                                        "OIDocumentID": "@body('Parse_JSON_imageinvoiceId')?['ImageInvoiceId']",
                                        "OIExported": "",
                                        "OIFutureDatedInvoice": "",
                                        "OIInvoiceAmount": "",
                                        "OIInvoiceNumber": "",
                                        "OIPOInvoice": "",
                                        "OIVendor": "",
                                        "OIInvoiceDate": "",
                                        "RetryCount": "0",
                                        "Identifier": "@{workflow()['run']['name']}",
                                        "WORKFLOW": "@{workflow()['name']}"
                                    }
                                }
                            },
                            "serviceProviderConfiguration": {
                                "connectionName": "PrivateServiceBus",
                                "operationId": "sendMessage",
                                "serviceProviderId": "/serviceProviders/serviceBus"
                            }
                        },
                        "runAfter": {
                            "Send_message_to_retry_queue": [
                                "Succeeded"
                            ]
                        }
                    },
                    "Send_message_to_OI_invoice_skipped": {
                        "type": "ServiceProvider",
                        "inputs": {
                            "parameters": {
                                "entityName": "open-invoice-post-update",
                                "message": {
                                    "contentData": {
                                        "OIinvoiceReceived": "0",
                                        "MessageBody": "D365 Journal creation skipped, Either the invoice is not in approved state or the invoice date is in future.",
                                        "OIDocumentID": "@{variables('ImageinvoiceId')}",
                                        "RetryQueue": "0"
                                    }
                                }
                            },
                            "serviceProviderConfiguration": {
                                "connectionName": "PrivateServiceBus",
                                "operationId": "sendMessage",
                                "serviceProviderId": "/serviceProviders/serviceBus"
                            }
                        },
                        "runAfter": {
                            "Send_message_audit_error": [
                                "Succeeded"
                            ]
                        }
                    }
                },
                "runAfter": {
                    "Compose": [
                        "Succeeded"
                    ]
                }
            },
            "Initialize_errorLog": {
                "type": "InitializeVariable",
                "inputs": {
                    "variables": [
                        {
                            "name": "errorLog",
                            "type": "string"
                        }
                    ]
                },
                "runAfter": {
                    "Initialize_Location": [
                        "Succeeded"
                    ]
                }
            },
            "Set_errorLog": {
                "type": "SetVariable",
                "inputs": {
                    "name": "errorLog",
                    "value": "@{body('Get_latest_error_log')?['value']?[0]?['MessageBody']}"
                },
                "runAfter": {
                    "Get_latest_error_log": [
                        "Succeeded"
                    ]
                }
            },
            "Compose_to_send_imageInvoiceId_to_retry_Queue": {
                "type": "Compose",
                "inputs": {
                    "ImageInvoiceId": "@variables('ImageinvoiceId')"
                },
                "runAfter": {
                    "Parse_JSON_for_VendAccount": [
                        "Succeeded"
                    ]
                }
            },
            "Initialize_Location": {
                "type": "InitializeVariable",
                "inputs": {
                    "variables": [
                        {
                            "name": "Location",
                            "type": "string"
                        }
                    ]
                },
                "runAfter": {
                    "Initialize_Companycount": [
                        "Succeeded"
                    ]
                }
            },
            "Initialize_FileCount": {
                "type": "InitializeVariable",
                "inputs": {
                    "variables": [
                        {
                            "name": "FileCount",
                            "type": "integer"
                        }
                    ]
                },
                "runAfter": {
                    "Initialize_countLedJournLine": [
                        "Succeeded"
                    ]
                }
            },
            "Initialize_FileType": {
                "type": "InitializeVariable",
                "inputs": {
                    "variables": [
                        {
                            "name": "FileType",
                            "type": "array"
                        }
                    ]
                },
                "runAfter": {
                    "Initialize_ProjCatCount": [
                        "Succeeded"
                    ]
                }
            },
            "Initialize_vendName": {
                "type": "InitializeVariable",
                "inputs": {
                    "variables": [
                        {
                            "name": "VendName",
                            "type": "string"
                        }
                    ]
                },
                "runAfter": {
                    "Initialize_LocationPath": [
                        "Succeeded"
                    ]
                }
            },
            "Initialize_DocumentName": {
                "type": "InitializeVariable",
                "inputs": {
                    "variables": [
                        {
                            "name": "DocumentName",
                            "type": "string"
                        }
                    ]
                },
                "runAfter": {
                    "Initialize_vendName": [
                        "Succeeded"
                    ]
                }
            },
            "Get_rows_(V2)": {
                "type": "ApiConnection",
                "inputs": {
                    "host": {
                        "connection": {
                            "referenceName": "sql_auditLogging"
                        }
                    },
                    "method": "get",
                    "path": "/v2/datasets/@{encodeURIComponent(encodeURIComponent(parameters('OIServerName')))},@{encodeURIComponent(encodeURIComponent(parameters('OIDBName')))}/tables/@{encodeURIComponent(encodeURIComponent('[dbo].[D365APInvoiceAudit]'))}/items",
                    "queries": {
                        "$filter": "OIDocumentID eq '@{body('Parse_JSON_imageinvoiceId')?['ImageInvoiceId']}' and D365JournalCreated eq '1'"
                    }
                },
                "runAfter": {
                    "Initialize_imageinvoiceId": [
                        "Succeeded"
                    ]
                }
            },
            "Condition_2": {
                "type": "If",
                "expression": {
                    "and": [
                        {
                            "greater": [
                                "@length(body('Get_rows_(V2)')?['value'])",
                                0
                            ]
                        }
                    ]
                },
                "actions": {
                    "Terminate_4": {
                        "type": "Terminate",
                        "inputs": {
                            "runStatus": "Failed"
                        },
                        "runAfter": {
                            "Send_Audit_for_Duplicate_Invoice": [
                                "Succeeded"
                            ]
                        }
                    },
                    "Send_Audit_for_Duplicate_Invoice": {
                        "type": "ServiceProvider",
                        "inputs": {
                            "parameters": {
                                "entityName": "open-invoice-audit",
                                "message": {
                                    "contentData": {
                                        "D365AttachmentAdded": "",
                                        "D365JENumber": "",
                                        "D365JournalCreated": "1",
                                        "D365JournalPosted": "0",
                                        "InRetryQueue": "",
                                        "LastUpdated": "@convertFromUtc(utcNow(), 'Mountain Standard Time')",
                                        "MessageBody": "Duplicate invoice skipped ",
                                        "OIApproved": "1",
                                        "OIDocDataRetrieved": "",
                                        "OIDocumentID": "@body('Parse_JSON_imageinvoiceId')?['ImageInvoiceId']",
                                        "OIExported": "",
                                        "OIFutureDatedInvoice": "",
                                        "OIInvoiceAmount": "",
                                        "OIInvoiceNumber": "",
                                        "OIPOInvoice": "",
                                        "OIVendor": "",
                                        "OIInvoiceDate": "",
                                        "RetryCount": "0",
                                        "Identifier": "@{workflow()['run']['name']}",
                                        "WORKFLOW": "@{workflow()['name']}"
                                    }
                                }
                            },
                            "serviceProviderConfiguration": {
                                "connectionName": "PrivateServiceBus",
                                "operationId": "sendMessage",
                                "serviceProviderId": "/serviceProviders/serviceBus"
                            }
                        },
                        "runAfter": {}
                    }
                },
                "runAfter": {
                    "Get_rows_(V2)": [
                        "Succeeded"
                    ]
                }
            },
            "Set_variable_legal_entity": {
                "type": "SetVariable",
                "inputs": {
                    "name": "CompanyId",
                    "value": "@{if(equals(body('Parse_JSON_invoice_details')?['SupplierConnectInvoice']?['Invoice']?['InvoiceHeader']?['DocumentAction']?[0]?['ActionSource']?['Site']?['SiteCode']?['#text'],'Legal'),'sesc',body('Parse_JSON_invoice_details')?['SupplierConnectInvoice']?['Invoice']?['InvoiceHeader']?['DocumentAction']?[0]?['ActionSource']?['Site']?['SiteCode']?['#text'])}"
                },
                "runAfter": {
                    "Compose_to_send_imageInvoiceId_to_retry_Queue": [
                        "Succeeded"
                    ]
                }
            },
            "Compose": {
                "type": "Compose",
                "inputs": "@body('Parse_JSON_invoice_details')?['SupplierConnectInvoice']?['Invoice']?['InvoiceHeader']?['DocumentAction']?[0]?['Status']",
                "runAfter": {
                    "Set_errorLog": [
                        "Succeeded"
                    ]
                }
            },
            "Initialize_variable_referenceData": {
                "type": "InitializeVariable",
                "inputs": {
                    "variables": [
                        {
                            "name": "referenceData",
                            "type": "string"
                        }
                    ]
                },
                "runAfter": {
                    "Initialize_UniversalResourceIdentifier": [
                        "Succeeded"
                    ]
                }
            }
        },
        "triggers": {
            "When_messages_are_available_in_a_queue": {
                "type": "ServiceProvider",
                "inputs": {
                    "parameters": {
                        "queueName": "open-invoice-primary",
                        "isSessionsEnabled": false
                    },
                    "serviceProviderConfiguration": {
                        "connectionName": "PrivateServiceBus",
                        "operationId": "receiveQueueMessages",
                        "serviceProviderId": "/serviceProviders/serviceBus"
                    }
                },
                "splitOn": "@triggerOutputs()?['body']"
            }
        },
        "contentVersion": "1.0.0.0",
        "outputs": {}
    },
    "kind": "Stateful"
}